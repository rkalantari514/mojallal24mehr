{% extends 'shared/_MainLayout.html' %}
{% load humanize %}
{% load static %}
{% block content %}
    <style>
        .circle-progress .in .text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .circle-progress .in .value {
            font-size: 20px; /* تنظیم اندازه متن */
        }

        .category-btn {
            width: 200px; /* عرض دکمه‌ها را تنظیم می‌کند */
            margin-bottom: 10px; /* فاصله بین خطوط را تنظیم می‌کند */
        }


    </style>
    <style>
        .calendar-table {
            table-layout: fixed;
            width: 100%;
            border-collapse: collapse;
        }

        .calendar-table th, .calendar-table td {
            width: 14.28%;
            height: 100px;
            text-align: center;
            vertical-align: top;
            border: 1px solid #fdd49a;
        }

        .calendar-table th {
            height: auto; /* تغییر ارتفاع ستون هدر */
        }

        .calendar-table .fc-day-top {
            background-color: #f9f9f9; /* رنگ پس‌زمینه کم‌رنگ */
            position: relative; /* برای قرار دادن فرزندان */
            height: 100%; /* ارتفاع کامل سلول */
        }

        .calendar-table .fc-day-number {
            font-weight: bold;
            display: block;
            margin: 0; /* لغو حاشیه */
            padding-top: 0px; /* فاصله با بالای سلول */
        }

        .calendar-table .fc-kharid-number,
        .calendar-table .fc-sales-number {
            font-size: 1.2rem; /* اندازه متن */
        }

        .calendar-table .fc-kharid-number {
            color: #007bff; /* رنگ سبد خرید */
            position: absolute;
            bottom: 0px; /* فاصله از پایین سلول */
            left: 0px; /* فاصله از چپ سلول */
            text-align: left; /* تراز چپ */
        }

        .calendar-table .fc-sales-number {
            color: #28a745; /* رنگ کامیون */
            position: absolute;
            bottom: 0px; /* فاصله از پایین سلول */
            right: 0px; /* فاصله از راست سلول */
            text-align: right; /* تراز راست */
        }
    </style>
    <style>
/* استایل برای لینک‌دار کردن کل سطر */
.table-hover tbody tr {
    cursor: pointer;
    transition: background-color 0.15s;
}
.table-hover tbody tr:hover {
    background-color: #f8f9fa !important;
}
/* جلوگیری از تداخل با لینک‌های داخل سلول */
.table-hover tbody tr a {
    color: inherit;
    text-decoration: none;
}
.table-hover tbody tr a:hover {
    text-decoration: underline;
}
</style>


    <div class="content-wrapper">

        <div class="page-title">
            <div class="row">
                <div class="col-sm-6">
                    <div class="d-block">
                        {% if cat_level == 0 %}
                            <h4 class="card-title text-facebook pb-0 border-0">همه دسته بندی ها<span
                                    class="badge badge-pill badge-success">0</span></h4>
                        {% elif cat_level == 1 %}
                            <h4 class="card-title text-facebook pb-0 border-0">دسته بندی: {{ cat.name }}<span
                                    class="badge badge-pill badge-success">1</span></h4>
                        {% elif cat_level == 2 %}
                            <h4 class="card-title text-facebook pb-0 border-0">دسته بندی: {{ cat.name }}<span
                                    class="badge badge-pill badge-info">2</span></h4>
                        {% elif cat_level == 3 %}
                            <h4 class="card-title text-facebook pb-0 border-0">دسته بندی: {{ cat.name }}<span
                                    class="badge badge-pill badge-primary">3</span></h4>

                        {% endif %}
                    </div>

                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb pt-0 pr-0 float-left float-sm-right">
                        <li class="breadcrumb-item"><a href="/" class="default-color"> خانه</a></li>
                        <li class="breadcrumb-item active">{{ cat.name }}</li>

                    </ol>
                </div>
            </div>
            <!-- ردیف دسته بندی ها -->
            <div class="text-center">
                {% if  cat_level == 0 %}
                    <button type="button" class="btn btn-success category-btn">همه دسته بندی ها</button>
                {% else %}
                    <a href="/dash/kala/category/0">
                        <button type="button" class="btn btn-success category-btn">همه دسته بندی ها</button>
                    </a>
                {% endif %}

            </div>

            <div class="text-center">
                {% for c in cat1 %}
                    {% if c == par1 or c == cat %}
                        <a href="/dash/kala/category/{{ c.id }}">
                            <button type="button" class="btn btn-success category-btn">{{ c.name }}</button>
                        </a>
                    {% else %}
                        <a href="/dash/kala/category/{{ c.id }}">
                            <button type="button" class="btn btn-secondary category-btn">{{ c.name }}</button>
                        </a>
                    {% endif %}
                {% endfor %}

            </div>

            <div class="text-center border-top my-3">
                {% for c in cat2 %}
                    {% if c == par2 %}
                        <a href="/dash/kala/category/{{ c.id }}">
                            <button type="button" class="btn btn-info category-btn">{{ c.name }}</button>
                        </a>
                    {% else %}
                        <a href="/dash/kala/category/{{ c.id }}">
                            <button type="button" class="btn btn-secondary category-btn">{{ c.name }}</button>
                        </a>
                    {% endif %}
                {% endfor %}
            </div>

            <div class="text-center border-top my-3">
                {% for c in cat3 %}
                    {% if c == cat %}
                        <a href="/dash/kala/category/{{ c.id }}">
                            <button type="button" class="btn btn-primary category-btn">{{ c.name }}</button>
                        </a>
                    {% else %}
                        <a href="/dash/kala/category/{{ c.id }}">
                            <button type="button" class="btn btn-secondary category-btn">{{ c.name }}</button>
                        </a>
                    {% endif %}
                {% endfor %}
            </div>


            <!-- ردیف اول خلاصه ها -->
            <div class="row">
                <div class="col-xl-3 col-lg-6 col-md-6 mb-30">
                    <div class="card card-statistics h-100">
                        <div class="card-body">
                            <div class="clearfix">
                                <div class="float-left icon-box bg-danger rounded-circle">
    <span class="text-white">
    <i class="fa fa-bar-chart-o highlight-icon" aria-hidden="true"></i>
    </span>
                                </div>
                                <div class="float-right text-right">
                                    <p class="card-text text-dark"> کل موجودی</p>
                                    <h4>{{ master_data.totl_mojodi }}</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-lg-6 col-md-6 mb-30">
                    <div class="card card-statistics h-100">
                        <div class="card-body">
                            <div class="clearfix">
                                <div class="float-left icon-box bg-primary rounded-circle">
    <span class="text-white">
    <i class="fa fa-dollar highlight-icon" aria-hidden="true"></i>
    </span>
                                </div>
                                <div class="float-right text-right">
                                    <p class="card-text text-dark"> ارزش موجودی </p>
                                    <h4>{{ master_data.total_arzesh|intword }} ریال</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-lg-6 col-md-6 mb-30">
                    <div class="card card-statistics h-100">
                        <div class="card-body">
                            <div class="clearfix">
                                <div class="float-left icon-box bg-warning rounded-circle">
    <span class="text-white">
    <i class="fa fa-shopping-cart highlight-icon" aria-hidden="true"></i>
    </span>
                                </div>
                                <div class="float-right text-right">
                                    <p class="card-text text-dark"> تعداد کل فروش از ابتدای دوره</p>
                                    <h4>{{ master_data.total_sale }}</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {#                <div class="col-xl-3 col-lg-6 col-md-6 mb-30">#}
                {#                    <div class="card card-statistics h-100">#}
                {#                        <div class="card-body">#}
                {#                            <div class="clearfix">#}
                {#                                <div class="float-left icon-box bg-info rounded-circle">#}
                {#    <span class="text-white">#}
                {#    <i class="fa fa-percent highlight-icon" aria-hidden="true"></i>#}
                {#    </span>#}
                {#                                </div>#}
                {#                                <div class="float-right text-right">#}
                {#                                    <p class="card-text text-dark"> درصد فروش به موجودی روز </p>#}
                {#                                    <h4>{{ master_data.s_m_ratio|floatformat:2 }}%</h4>#}
                {#                                </div>#}
                {#                            </div>#}
                {#                        </div>#}
                {#                    </div>#}
                {#                </div>#}
            </div>
            <!-- ردیف دوم خلاصه ها -->
            <div class="row">
                {#                <div class="col-xl-3 col-lg-6 col-md-6 mb-30">#}
                {#                    <div class="card card-statistics h-100">#}
                {#                        <div class="card-body">#}
                {#                            <div class="clearfix">#}
                {#                                <div class="float-left icon-box bg-dribbble rounded-circle">#}
                {#    <span class="text-white">#}
                {#    <i class="fa fa-calendar-check-o highlight-icon" aria-hidden="true"></i>#}
                {#    </span>#}
                {#                                </div>#}
                {#                                <div class="float-right text-right">#}
                {#                                    <p class="card-text text-dark">موجودی × روز از ابتدای دوره</p>#}
                {#                                    <h4>{{ master_data.mojodi_roz|intword }}</h4>#}
                {#                                </div>#}
                {#                            </div>#}
                {#                        </div>#}
                {#                    </div>#}
                {#                </div>#}
                {#                <div class="col-xl-3 col-lg-6 col-md-6 mb-30">#}
                {#                    <div class="card card-statistics h-100">#}
                {#                        <div class="card-body">#}
                {#                            <div class="clearfix">#}
                {#                                <div class="float-left icon-box bg-facebook rounded-circle">#}
                {#    <span class="text-white">#}
                {#    <i class="fa fa-bed highlight-icon" aria-hidden="true"></i>#}
                {#    </span>#}
                {#                                </div>#}
                {#                                <div class="float-right text-right">#}
                {#                                    <p class="card-text text-dark">موجودی روز ارزش میانگین</p>#}
                {#                                    <h4>{{ master_data.mojodi_roz_arzesh|intword }} ریال روز</h4>#}
                {#                                </div>#}
                {#                            </div>#}
                {#                        </div>#}
                {#                    </div>#}
                {#                </div>#}
                {#            <div class="col-xl-3 col-lg-6 col-md-6 mb-30">#}
                {#                <div class="card card-statistics h-100">#}
                {#                    <div class="card-body">#}
                {#                        <div class="clearfix">#}
                {#                            <div class="float-left icon-box bg-warning rounded-circle">#}
                {#    <span class="text-white">#}
                {#    <i class="fa fa-shopping-cart highlight-icon" aria-hidden="true"></i>#}
                {#    </span>#}
                {#                            </div>#}
                {#                            <div class="float-right text-right">#}
                {#                                <p class="card-text text-dark"> تعداد کل فروش از ابتدای دوره</p>#}
                {#                                <h4>{{ kala.total_sales }}</h4>#}
                {#                                <h4>{{ kala.total_sale }}</h4>#}
                {#                            </div>#}
                {#                        </div>#}
                {#                    </div>#}
                {#                </div>#}
                {#            </div>#}
                {#            <div class="col-xl-3 col-lg-6 col-md-6 mb-30">#}
                {#                <div class="card card-statistics h-100">#}
                {#                    <div class="card-body">#}
                {#                        <div class="clearfix">#}
                {#                            <div class="float-left icon-box bg-info rounded-circle">#}
                {#    <span class="text-white">#}
                {#    <i class="fa fa-calendar-check-o highlight-icon" aria-hidden="true"></i>#}
                {#    </span>#}
                {#                            </div>#}
                {#                            <div class="float-right text-right">#}
                {#                                <p class="card-text text-dark"> نسبت فروش به موجودی از ابتدای دوره </p>#}
                {#                                <h4>{{ kala.s_m_ratio|floatformat:4 }}</h4>#}
                {#                                <p class="card-text text-dark"> موجودی × روز </p>#}
                {#                                <h4>{{ mojodi.last.mojodi_roz|floatformat:2 }}</h4>#}
                {#                                <p class="card-text text-dark"> نسبت فروش به موجودی روز</p>#}
                {#                                <h4>{{ m_r_s|floatformat:2 }}</h4>#}
                {#                            </div>#}
                {#                        </div>#}
                {#                    </div>#}
                {#                </div>#}
                {#            </div>#}
            </div>


            <!-- ردیف رتبه ها -->
            {#        <div class="card card-statistics">#}
            {#            <div class="card-body bg-white">#}
            {#                <h5 class="card-title"> رکورد ها و جایگاه کالا </h5>#}
            {#                <div class="row">#}
            {#                    <div class="col-xl-3 col-sm-6">#}
            {#                        <div class="row">#}
            {#                            <div class="col-md-7 col-sm-7 col-7 align-self-center">#}
            {#                                <span> رسوب کالا در انبار</span>#}
            {#                                <h4 class="text-danger fw-6 mt-10">{{ rosob }} روز </h4>#}
            {#                            </div>#}
            {#                            <div class="col-4">#}
            {#                                <div id="circle1" class="circle-progress">#}
            {#                                    <div class="in">#}
            {#                                        <div class="text">#}
            {#                                            <h3 class="value">{{ rosob }}</h3>#}
            {#                                        </div>#}
            {#                                    </div>#}
            {#                                </div>#}
            {#                            </div>#}
            {#                        </div>#}
            {#                    </div>#}
            {#                    <div class="col-xl-3 col-sm-6">#}
            {#                        <div class="row">#}
            {#                            <div class="col-md-7 col-sm-7 col-7 align-self-center">#}
            {#                                <span> رتبه نسبت فروش به موجودی</span>#}
            {#                                <h4 class="text-success fw-6 mt-10"> رتبه{{ rank }} در گروه</h4>#}
            {#                            </div>#}
            {#                            <div class="col-4">#}
            {#                                <div id="circle2" class="circle-progress">#}
            {#                                    <div class="in">#}
            {#                                        <div class="text">#}
            {#                                            <h3 class="value">{{ rank }}</h3>#}
            {#                                        </div>#}
            {#                                    </div>#}
            {#                                </div>#}
            {#                            </div>#}
            {#                        <div class="col-md-5 col-sm-5 col-5 align-self-center text-right">#}{#                   <span class="round-chart mb-0" data-percent={{ rankper }} data-size="80" data-width="4"#}{#                         data-color="#28a745">#}{#                       <span class="percent" style="width: 80px; height: 80px; line-height: 80px;">---</span>#}{#                   </span>#}{#                        </div>#}
            {#                        </div>#}
            {##}
            {#                    </div>#}
            {#                <div class="col-xl-3 col-sm-6">#}{#                    <div class="row">#}{#                        <div class="col-md-7 col-sm-7 col-7 align-self-center">#}{#                            <span>=======</span>#}{#                            <h4 class="text-info fw-6 mt-10">=======</h4>#}{#                        </div>#}{##}{#                        <div class="col-4">#}{#                            <div id="circle1" class="circle-progress">#}{#                                <div class="in">#}{#                                    <div class="text">#}{#                                        <h4 class="value">200</h4>#}{#                                    </div>#}{#                                </div>#}{#                            </div>#}{#                        </div>#}{#                    </div>#}{#                </div>#}
            {##}
            {##}
            {#                    <div class="col-xl-3 col-sm-6">#}
            {#                        <div class="row">#}
            {#                            <div class="col-md-7 col-sm-7 col-7 align-self-center">#}
            {#                                <span> + + + + + + + +</span>#}
            {#                                <h4 class="text-warning fw-6 mt-10"> + + + + + +</h4>#}
            {#                            </div>#}
            {#                            <div class="col-md-5 col-sm-5 col-5 align-self-center text-right">#}
            {#    <span class="round-chart mb-0" data-percent="80" data-size="80" data-width="4" data-color="#ffc107">#}
            {#    <span class="percent" style="width: 80px; height: 80px; line-height: 80px;">80</span >#}
            {#                     <canvas height="80" width="80"></canvas>#}
            {#    </span>#}
            {#                            </div>#}
            {#                        </div>#}
            {#                    </div>#}
            {#                </div>#}
            {#            </div>#}
            {#        </div>#}
            {#        <br>#}
            <!-- ردیف کلیات و نمودار فروش -->

            <div class="d-block d-md-flex justify-content-between">
                <div class="d-block">
                    {% if cat_level == 1 %}
                        <h4 class="card-title text-facebook pb-0 border-0 text-center">دسته
                            بندی: {{ cat.name }}<span
                                    class="badge badge-pill badge-success float-right">1</span></h4>
                    {% elif cat_level == 2 %}
                        <h4 class="card-title text-facebook pb-0 border-0 text-center">دسته
                            بندی: {{ cat.name }}<span
                                    class="badge badge-pill badge-info float-right">2</span></h4>

                    {% elif cat_level == 3 %}
                        <h4 class="card-title text-facebook pb-0 border-0 text-center">دسته
                            بندی: {{ cat.name }}<span
                                    class="badge badge-pill badge-primary float-right">3</span></h4>

                    {% endif %}
                </div>

            </div>

            <!-- ردیف دونات ومیله ای / تعداد -->
            <div class="row">
                <div class="col-md-5 mb-30">
                    <div class="card card-statistics h-100">
                        <div class="card-body col-9">
                            <h5 class="card-title pb-0 border-0 ">سهم فروش- تعداد</h5>
                            <canvas id="donat-forosh"></canvas>
                        </div>
                    </div>

                </div>
                <div class="col-md-7 mb-30">
                    <div class="card card-statistics h-100">
                        <div class="card-body">
                            {#                            <h5 class="card-title pb-0 border-0 "> فروش ماهانه- تعداد</h5>#}

                            <canvas id="myChart" width="400" height="300" style="width: 100%; height: 300px;"></canvas>
                            {#<canvas id="myChart"></canvas>#}
                        </div>
                    </div>

                </div>
            </div>

            <!-- ردیف دونات ومیله ای / مبلغ -->
            <div class="row">
                <div class="col-md-5 mb-30">
                    <div class="card card-statistics h-100">
                        <div class="card-body col-9">
                            <h5 class="card-title pb-0 border-0 ">سهم فروش- مبلغ</h5>
                            <canvas id="donat-forosh-mablagh"></canvas>
                        </div>
                    </div>

                </div>
                <div class="col-md-7 mb-30">
                    <div class="card card-statistics h-100">
                        <div class="card-body">
                            {#<canvas id="myChart2"></canvas>#}
                            <canvas id="myChart2" width="400" height="300" style="width: 100%; height: 300px;"></canvas>

                        </div>
                    </div>

                </div>
            </div>


            <!-- ردیف جدول کالاها -->
<div class="row">
    <div class="col-md-12 mb-30">
        <div class="col-xl-12 mb-30">
            <div class="card card-statistics h-100">
                <div class="card-body">
                    <div class="table-responsive mt-15">
                        <h6 class="card-title pb-0 border-0">کالاهای دسته‌بندی {{ cat.name }}</h6>

                        <div class="table-responsive">
                            <table
                                id="table"
                                class="table-striped table-hover"
                                data-toggle="table"
                                data-locale="fa-IR"
                                data-search="true"
                                data-show-columns="true"
                                data-show-export="true"
                                data-show-refresh="true"
                                data-show-columns-toggle-all="true"
                                data-show-pagination-switch="true"
                                data-show-toggle="true"
                                data-show-fullscreen="true"
                                data-buttons="buttons"
                                data-search-align="left"
                                data-buttons-class="primary"
                                data-pagination="true"
                                data-show-columns-search="true"
                                data-show-footer="true"
                                data-page-size="10"
                                data-remember-order="true"
                                data-sortable="true"
                                data-show-search-clear-button="true"
                                data-sort-name="net_total"
                                data-sort-order="desc"
                                data-filter-control="true"
                                data-show-print="true"
                                data-export-data-type="all"
                                data-export-types='["excel"]'
                            >
                                <thead>
                                    <!-- سطر اول: گزارش فروش (merged) -->
                                    <tr class="tr-class-1">
                                        <th rowspan="2" class="card-text text-center" data-sortable="true" data-field="name">نام کالا</th>
                                        <th rowspan="2" class="card-text text-center" data-sortable="true" data-field="brand" data-filter-control="select">برند</th>

                                        {% if cat_level == 0 %}
                                            <th rowspan="2" class="card-text text-center" data-sortable="true" data-field="cat_kala1" data-filter-control="select">سطح 1</th>
                                        {% endif %}
                                        {% if cat_level < 2 %}
                                            <th rowspan="2" class="card-text text-center" data-sortable="true" data-field="cat_kala2" data-filter-control="select">سطح 2</th>
                                        {% endif %}
                                        {% if cat_level < 3 %}
                                            <th rowspan="2" class="card-text text-center" data-sortable="true" data-field="cat_kala3" data-filter-control="select">سطح 3</th>
                                        {% endif %}

                                        <th rowspan="2" class="card-text text-center"
                                            data-sortable="true"
                                            data-field="mojodi"
                                            data-formatter="numberFormatter"
                                            data-footer-formatter="priceFormatter"
                                            data-sorter="numericSorter">کل موجودی</th>

                                        <!-- گزارش فروش -->
                                        <th colspan="5" class="card-text text-center bg-light">گزارش فروش</th>
                                    </tr>

                                    <!-- سطر دوم: جزئیات فروش -->
                                    <tr class="tr-class-1">
                                        <th class="card-text text-center"
                                            data-sortable="true"
                                            data-field="net_past_w"
                                            data-formatter="numberFormatter"
                                            data-footer-formatter="priceFormatter"
                                            data-sorter="numericSorter">یک هفته گذشته</th>

                                        <th class="card-text text-center"
                                            data-sortable="true"
                                            data-field="net_past_m"
                                            data-formatter="numberFormatter"
                                            data-footer-formatter="priceFormatter"
                                            data-sorter="numericSorter">یک ماه گذشته</th>

                                        <th class="card-text text-center"
                                            data-sortable="true"
                                            data-field="net_past_6m"
                                            data-formatter="numberFormatter"
                                            data-footer-formatter="priceFormatter"
                                            data-sorter="numericSorter"> 6 ماه گذشته</th>

                                        <th class="card-text text-center"
                                            data-sortable="true"
                                            data-field="net_past_year"
                                            data-formatter="numberFormatter"
                                            data-footer-formatter="priceFormatter"
                                            data-sorter="numericSorter">یک سال گذشته</th>

                                        <th class="card-text text-center"
                                            data-sortable="true"
                                            data-field="net_total"
                                            data-formatter="numberFormatter"
                                            data-footer-formatter="priceFormatter"
                                            data-sorter="numericSorter">از ابتدای 1403</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for kala in kalas %}
                                        <tr data-href="/dash/kala/detail/{{ kala.code }}" data-target="_blank">
                                            <td class="card-text text-center">{{ kala.name }}</td>
                                            <td class="card-text text-center">{{ kala.brand.name }}</td>

                                            {% if cat_level == 0 %}
                                                <td class="card-text text-center">{{ kala.category.parent.parent.name }}</td>
                                            {% endif %}
                                            {% if cat_level < 2 %}
                                                <td class="card-text text-center">{{ kala.category.parent.name }}</td>
                                            {% endif %}
                                            {% if cat_level < 3 %}
                                                <td class="card-text text-center">{{ kala.category.name }}</td>
                                            {% endif %}

                                            <td class="card-text text-center">{{ kala.latest_mojodi|default:0 }}</td>
                                            <td class="card-text text-center">{{ kala.net_sale_last_week|default:0 }}</td>
                                            <td class="card-text text-center">{{ kala.net_sale_last_month|default:0 }}</td>
                                            <td class="card-text text-center">{{ kala.net_sale_last_6m|default:0 }}</td>
                                            <td class="card-text text-center">{{ kala.net_sale_last_year|default:0 }}</td>
                                            <td class="card-text text-center">{{ kala.net_sale_total|default:0 }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

            <!-- ردیف  تقویم -->
            <div class="row">
                <div id="calendarf" class="col-md-7 mb-30">
                    <div class="card card-statistics h-100">
                        <div class="card-body">
                            <h5 class="card-title pb-0 border-0 "> خرید و فروش روزانه</h5>
                            <div class="text-center mb-4">
                                <h2>{{ month_name }} {{ year }}</h2>
                            </div>
                            <div class="calendar-header">
                                <button id="prev-month" class="btn btn-secondary">&lt;</button>
                                <span>{{ month_name }} {{ year }}</span>
                                <button id="next-month" class="btn btn-secondary">&gt;</button>
                            </div>
                            <table class="table table-bordered calendar-table">
                                <thead class="thead-light">
                                <tr>
                                    <th>شنبه</th>
                                    <th>یکشنبه</th>
                                    <th>دوشنبه</th>
                                    <th>سه‌شنبه</th>
                                    <th>چهارشنبه</th>
                                    <th>پنج‌شنبه</th>
                                    <th>جمعه</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for week in days_in_month %}
                                    <tr>
                                        {% for day in week %} {% if day %}
                                            <td>
                                                <div class="fc-day-top">
                                                    <span class="fc-day-number">{{ day.jday }}</span>
                                                    {% if day.kharid > 0 %}
                                                        <span class="fc-kharid-number">
                                                    <i class="fa fa-truck">

                                                    </i> {{ day.kharid|floatformat:0 }}</span>
                                                    {% endif %}
                                                    {% if day.sales > 0 %}
                                                        <span class="fc-sales-number">{{ day.sales|floatformat:0 }}
                                                    <i class="fa fa-shopping-cart"></i>
                                                </span>
                                                    {% endif %}
                                                </div>
                                            </td>
                                        {% else %}
                                            <td>

                                            </td>
                                        {% endif %}
                                        {% endfor %}
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>


            </div>
        </div>

    </div>




{% endblock %}


{% block jscal %}

    {#    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>#}

    <script>

        $(document).ready(function () {
            var currentYear = {{ year }};
            var currentMonth = {{ month }};
            var code1 = {{ cat_id }};
            var url = `/dash/kala/category/${code1}`;

            console.log("Initial setup");
            console.log("Current Year: " + currentYear);
            console.log("Current Month: " + currentMonth);
            console.log("Code1: " + code1);
            console.log("Initial URL: " + url);

            function loadCalendar(month, year) {
                console.log("Loading calendar for month: " + month + ", year: " + year);
                console.log("URL being used for AJAX call: " + url);

                $.ajax({
                    url: url,
                    type: 'GET',
                    data: {month: month, year: year, code1: code1},
                    success: function (data) {
                        console.log("AJAX call success");
                        $('#calendarf').html(data);
                    },
                    error: function (xhr, status, error) {
                        console.error('Error loading calendar: ', error);
                        console.error('XHR:', xhr);
                        console.error('Status:', status);
                    }
                });
            }

            $('#prev-month').click(function (e) {
                e.preventDefault();
                if (currentMonth === 1) {
                    currentMonth = 12;
                    currentYear -= 1;
                } else {
                    currentMonth -= 1;
                }
                console.log("Previous month clicked. New Month: " + currentMonth + ", Year: " + currentYear);
                loadCalendar(currentMonth, currentYear);
            });

            $('#next-month').click(function (e) {
                e.preventDefault();
                if (currentMonth === 12) {
                    currentMonth = 1;
                    currentYear += 1;
                } else {
                    currentMonth += 1;
                }
                console.log("Next month clicked. New Month: " + currentMonth + ", Year: " + currentYear);
                loadCalendar(currentMonth, currentYear);
            });
        });


    </script>
{% endblock %}



{% block myjs %}

    <!-- نمودار میله ای تعداد -->
    <script>
        const canvas = document.getElementById('myChart'); // این خط اضافی و استفاده نشده است، می‌توانید حذف کنید
        var myCharts = {}; // برای نگهداری نمونه‌های نمودارها

        function drawChart(canvasId, type, data, options) {
            var ctx = document.getElementById(canvasId);
            if (!ctx) {
                console.error("Canvas element with ID '" + canvasId + "' not found. Chart drawing cancelled for:", canvasId);
                return;
            }

            // اگر از یک wrapper برای canvas استفاده می‌کنید و maintainAspectRatio: false است،
            // می‌توانید ارتفاع canvas را به صورت اینلاین تنظیم کنید.
            // canvas.style.height = '400px'; // این خط را در صورت نیاز اضافه کنید

            ctx = ctx.getContext('2d');

            if (myCharts[canvasId]) {
                myCharts[canvasId].destroy();
            }
            myCharts[canvasId] = new Chart(ctx, {
                type: type,
                data: data,
                options: options
            });
            console.log(`Chart '${canvasId}' drawn successfully.`);
        }

        document.addEventListener('DOMContentLoaded', function () {
            console.log("DOM fully loaded and parsed. Script execution started.");

            // --- تنظیمات سراسری برای فارسی سازی Chart.js ---
            Chart.defaults.font.family = 'IRANSans, Arial, sans-serif';
            Chart.defaults.plugins.tooltip.rtl = true;
            Chart.defaults.plugins.legend.rtl = true;
            Chart.defaults.plugins.title.rtl = true;
            Chart.defaults.interaction.mode = 'index'; // برای نمایش tooltip همه میله‌ها در یک نقطه
            Chart.defaults.interaction.intersect = false; // برای tooltip، نیازی به قرار گرفتن دقیق روی میله نباشد

            // --- نمودار فروش ماهانه-تعداد (chart1) ---
            console.log("Attempting to load data for chart1...");
            var chart1_labels_data_element = document.getElementById('chart1-labels-data');
            var chart1_datasets_data_element = document.getElementById('chart1-datasets-data');

            if (!chart1_labels_data_element || !chart1_datasets_data_element) {
                console.error("Error: Chart1 data script elements not found. Check IDs or if data is passed from Django context correctly.");
                console.log("chart1-labels-data element:", chart1_labels_data_element);
                console.log("chart1-datasets-data element:", chart1_datasets_data_element);
                // return; // اگر المنت‌ها پیدا نشدند، از ادامه جلوگیری کنید
            } else {
                var chart1_labels_raw = chart1_labels_data_element.textContent;
                var chart1_datasets_raw = chart1_datasets_data_element.textContent;

                var chart1_labels;
                var chart1_datasets;

                try {
                    chart1_labels = JSON.parse(chart1_labels_raw);
                } catch (e) {
                    console.error("Error parsing chart1 Labels JSON:", e);
                    console.error("Raw Labels content that caused error:", chart1_labels_raw);
                    // return;
                }

                try {
                    chart1_datasets = JSON.parse(chart1_datasets_raw);
                } catch (e) {
                    console.error("Error parsing chart1 Datasets JSON:", e);
                    console.error("Raw Datasets content that caused error:", chart1_datasets_raw);
                    // return;
                }

                if (!chart1_labels || chart1_labels.length === 0 || !chart1_datasets || chart1_datasets.length === 0) {
                    console.warn("Chart1 data is empty or invalid. Not drawing chart.");
                    // return;
                } else {
                    var predefinedColors = [
                        'rgba(255, 99, 132, 0.7)', 'rgba(54, 162, 235, 0.7)', 'rgba(255, 206, 86, 0.7)',
                        'rgba(75, 192, 192, 0.7)', 'rgba(153, 102, 255, 0.7)', 'rgba(255, 159, 64, 0.7)',
                        'rgba(199, 199, 199, 0.7)', 'rgba(83, 102, 255, 0.7)'
                    ];
                    chart1_datasets.forEach((dataset, index) => {
                        const baseColor = predefinedColors[index % predefinedColors.length];
                        dataset.backgroundColor = baseColor;
                        dataset.borderColor = baseColor.replace('0.7', '1');
                    });

                    var chart1_data = {
                        labels: chart1_labels,
                        datasets: chart1_datasets
                    };

                    var chart1_options = {
                        responsive: true,
                        maintainAspectRatio: true, // !!! این را به false تغییر دهید !!!
                        plugins: {
                            title: {display: true, text: 'فروش ماهانه - تعداد', rtl: true, font: {size: 16}},
                            legend: {position: 'top', rtl: true, labels: {usePointStyle: true, font: {size: 14}}},
                            tooltip: {
                                rtl: true,
                                callbacks: {
                                    title: function (tooltipItems) {
                                        return tooltipItems[0].label;
                                    },
                                    label: function (tooltipItem) {
                                        let label = tooltipItem.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        label += tooltipItem.raw.toLocaleString('fa-IR', {maximumFractionDigits: 2});
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                stacked: false,
                                title: {display: true, text: 'ماه', rtl: true, font: {size: 14}},
                                ticks: {font: {size: 12}},
                                barPercentage: 0.8,
                                categoryPercentage: 0.8
                            },
                            y: {
                                beginAtZero: true, stacked: false,
                                ticks: {
                                    callback: function (value, index, values) {
                                        return value.toLocaleString('fa-IR', {maximumFractionDigits: 0});
                                    },
                                    font: {size: 12}
                                },
                                title: {display: true, text: 'تعداد', rtl: true, font: {size: 14}}
                            }
                        }
                    };
                    drawChart('myChart', 'bar', chart1_data, chart1_options);
                }
            }

            // --- نمودار دوم (myChart2) ---
            console.log("Attempting to load data for chart2...");
            var chart2_labels_data_element = document.getElementById('chart2-labels-data');
            var chart2_datasets_data_element = document.getElementById('chart2-datasets-data');

            if (!chart2_labels_data_element || !chart2_datasets_data_element) {
                console.error("Error: Chart2 data script elements not found. Check IDs or if data is passed from Django context correctly.");
                console.log("chart2-labels-data element:", chart2_labels_data_element);
                console.log("chart2-datasets-data element:", chart2_datasets_data_element);
                // return;
            } else {
                var chart2_labels_raw = chart2_labels_data_element.textContent;
                var chart2_datasets_raw = chart2_datasets_data_element.textContent;

                var chart2_labels;
                var chart2_datasets;

                try {
                    chart2_labels = JSON.parse(chart2_labels_raw);
                } catch (e) {
                    console.error("Error parsing chart2 Labels JSON:", e);
                    console.error("Raw Labels content that caused error:", chart2_labels_raw);
                    // return;
                }

                try {
                    chart2_datasets = JSON.parse(chart2_datasets_raw);
                } catch (e) {
                    console.error("Error parsing chart2 Datasets JSON:", e);
                    console.error("Raw Datasets content that caused error:", chart2_datasets_raw);
                    // return;
                }

                if (!chart2_labels || chart2_labels.length === 0 || !chart2_datasets || chart2_datasets.length === 0) {
                    console.warn("Chart2 data is empty or invalid. Not drawing chart.");
                    // return;
                } else {
                    // می‌توانید رنگ‌های خاصی برای chart2 تعریف کنید یا از همان predefinedColors استفاده کنید
                    var chart2_predefinedColors = [
                        'rgba(255, 99, 132, 0.7)', 'rgba(54, 162, 235, 0.7)', 'rgba(255, 206, 86, 0.7)',
                        'rgba(75, 192, 192, 0.7)', 'rgba(153, 102, 255, 0.7)', 'rgba(255, 159, 64, 0.7)',
                        'rgba(199, 199, 199, 0.7)', 'rgba(83, 102, 255, 0.7)'
                    ];
                    chart2_datasets.forEach((dataset, index) => {
                        const baseColor = chart2_predefinedColors[index % chart2_predefinedColors.length];
                        dataset.backgroundColor = baseColor;
                        dataset.borderColor = baseColor.replace('0.7', '1');
                    });

                    var chart2_data = {
                        labels: chart2_labels,
                        datasets: chart2_datasets
                    };

                    var chart2_options = {
                        responsive: true,
                        maintainAspectRatio: true, // !!! این را به false تغییر دهید !!!
                        plugins: {
                            title: {display: true, text: 'فروش ماهانه - مبلغ', rtl: true, font: {size: 16}},
                            legend: {position: 'top', rtl: true, labels: {usePointStyle: true, font: {size: 14}}},
                            tooltip: {
                                rtl: true,
                                callbacks: {
                                    title: function (tooltipItems) {
                                        return tooltipItems[0].label;
                                    },
                                    label: function (tooltipItem) {
                                        let label = tooltipItem.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        label += tooltipItem.raw.toLocaleString('fa-IR', {maximumFractionDigits: 2});
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                stacked: false,
                                title: {display: true, text: 'ماه', rtl: true, font: {size: 14}},
                                ticks: {font: {size: 12}},
                                barPercentage: 0.8,
                                categoryPercentage: 0.8
                            },
                            y: {
                                beginAtZero: true, stacked: false,
                                ticks: {
                                    callback: function (value, index, values) {
                                        return value.toLocaleString('fa-IR', {maximumFractionDigits: 0});
                                    },
                                    font: {size: 12}
                                },
                                title: {display: true, text: 'مبلغ فروش', rtl: true, font: {size: 14}}
                            }
                        }
                    };
                    drawChart('myChart2', 'bar', chart2_data, chart2_options);
                }
            }
        });
    </script>





    {{ chart1_labels|json_script:"chart1-labels-data" }}
    {{ chart1_datasets|json_script:"chart1-datasets-data" }}
    {{ chart2_labels|json_script:"chart2-labels-data" }}
    {{ chart2_datasets|json_script:"chart2-datasets-data" }}



    <!-- نمودار دونات فروش دسته ها -->
    <script>
        var labels = [
            {% for item in donat_forosh_data %}
                '{{ item.name }}',
            {% endfor %}
        ];
        var dataValues = [
            {% for item in donat_forosh_data %}
                {{ item.count }},
            {% endfor %}
        ];


        var data = {
            labels: labels,
            datasets: [{
                label: 'سهم فروش زیر مجموعه',
                data: dataValues,
                backgroundColor: [
                    window.chartColors.orange,
                    window.chartColors.yellow,
                    window.chartColors.green,
                    window.chartColors.blue,
                    window.chartColors.purple,
                    window.chartColors.cyan,
                    window.chartColors.pink,
                    window.chartColors.brown,
                    window.chartColors.lime,
                ],
                {#borderColor: borderColors,#}
                borderWidth: 1
            }]
        };

        var options = {
            responsive: true,
            maintainAspectRatio: true,
            legend: {
                position: 'bottom',
            },
            title: {
                display: false,
                text: 'نمودار دونات'
            },
            animation: {
                animateScale: true,
                animateRotate: true
            }, // اینجا ویرایش شده: اضافه کردن کاما

            tooltips: {
                callbacks: {
                    label: function (tooltipItem, data) {
                        var dataset = data.datasets[tooltipItem.datasetIndex];
                        var total = dataset.data.reduce((sum, value) => sum + value, 0);
                        var currentValue = dataset.data[tooltipItem.index];
                        var percentage = ((currentValue / total) * 100).toFixed(2);
                        return data.labels[tooltipItem.index] + ': ' + currentValue + ' (' + percentage + '%)';
                    }
                }
            }
        };


        drawChart('donat-forosh', 'doughnut', data, options);
    </script>

    <!-- نمودار دونات فروش دسته ها مبلغ-->

    <script>
        var labels = [
            {% for item in donat_forosh_mablagh %}
                '{{ item.name }}',
            {% endfor %}
        ];
        var dataValues = [
            {% for item in donat_forosh_mablagh %}
                {{ item.count }},
            {% endfor %}
        ];


        var data = {
            labels: labels,
            datasets: [{
                label: 'سهم فروش زیر مجموعه- مبلغ',
                data: dataValues,
                backgroundColor: [
                    window.chartColors.red,
                    window.chartColors.orange,
                    window.chartColors.yellow,
                    window.chartColors.green,
                    window.chartColors.blue,
                    window.chartColors.purple,
                    window.chartColors.cyan,
                    window.chartColors.pink,
                    window.chartColors.brown,
                    window.chartColors.lime,
                ]
                ,
                {#borderColor: borderColors,#}
                borderWidth: 1
            }]
        };

        var options = {
            responsive: true,
            maintainAspectRatio: true,
            legend: {
                position: 'bottom',
            },
            title: {
                display: false,
                text: 'نمودار دونات'
            },
            animation: {
                animateScale: true,
                animateRotate: true
            }
        {#scales: {#}
        {#    y: {#}
        {#        beginAtZero: true#}
        {#    }#}
        {#}#}
        }
        ;


        drawChart('donat-forosh-mablagh', 'doughnut', data, options);
    </script>


    <script src="{% static 'js/plugins/jquery-circle-progress/circle-progress.min.js' %}"></script>
    {#    <script>#}
    {#        function getColor(value) {#}
    {##}
    {#            if (value <= 1 / 12) {#}
    {#                return ["#00FF00", "#00FF00"];#}
    {#            } else if (value <= 2 / 12) {#}
    {#                return ["#FFFF00", "#FFFF00"];#}
    {#            } else if (value <= 3 / 12) {#}
    {#                return ["#FFA500", "#FFA500"];#}
    {#            } else {#}
    {#                return [#}
    {##}
    {#                    "#FF0000", "#FF0000"];#}
    {#            }#}
    {#        }#}
    {##}
    {#        var value = {{ rosobper }};#}
    {##}
    {#        $('#circle1').circleProgress({#}
    {#            value: value,#}
    {#            size: 80,#}
    {#            fill: {#}
    {#                gradient: getColor(value)#}
    {#            }#}
    {#            ,#}
    {#            animation: {#}
    {#                duration: 2000#}
    {#            }#}
    {#        })#}
    {#        ;#}
    {##}
    {#        $('#circle2').circleProgress({#}
    {#value: 0.25,#}
    {#            value: {{ rankper }},#}
    {#            size: 80,#}
    {#            fill: {#}
    {#                gradient: ["#EC4433", "#FE9500"]#}
    {#            }#}
    {#            ,#}
    {#            animation: {#}
    {#                duration: 2000#}
    {#            }#}
    {#        })#}
    {#        ;#}
    {#        $('#circle3').circleProgress({#}
    {#value: {{ rosobper }},#}
    {#            value: .0016556291390728,#}
    {#            size: 80,#}
    {#            fill: {#}
    {#                gradient: ["#00CDFF", "#1E74FD"]#}
    {#            }#}
    {#            ,#}
    {#            animation: {#}
    {#                duration: 2000#}
    {#            }#}
    {#        })#}
    {#        ;#}
    {#    </script>#}




{% endblock %}









{% block date %}
<script src="{% static 'js/table1/tableExport.min.js' %}"></script>
<script src="{% static 'js/table1/bootstrap-table.min.js' %}"></script>
<script src="{% static 'js/table1/bootstrap-table-locale-all.min.js' %}"></script>
<script src="{% static 'js/table1/bootstrap-table-export.min.js' %}"></script>
<script src="{% static 'js/table1/natural-sorting.js' %}"></script>
<script src="{% static 'js/table1/bootstrap-table-filter-control.min.js' %}"></script>
<script src="{% static 'js/table1/bootstrap-table-print.min.js' %}"></script>
<script src="{% static 'js/table1/jspdf.min.js' %}"></script>
<script src="{% static 'js/table1/jspdf.plugin.autotable.js' %}"></script>

<script>
// تابع کمکی برای استخراج عدد از مقدار (در صورت وجود HTML)
function extractNumberFromValue(val) {
    if (typeof val === 'string' && val.includes('<')) {
        var temp = document.createElement('div');
        temp.innerHTML = val;
        val = temp.textContent || temp.innerText || '';
    }
    var num = parseFloat(val);
    return isNaN(num) ? 0 : num;
}

// Formatter برای نمایش اعداد با کاما
numberFormatter = function(value, row, index) {
    var num = extractNumberFromValue(value);
    return num.toLocaleString('fa-IR', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    });
};

// Formatter برای فوتر (جمع)
priceFormatter = function(data) {
    var field = this.field;
    var total = 0;
    for (var i = 0; i < data.length; i++) {
        total += extractNumberFromValue(data[i][field]);
    }
    return total.toLocaleString('fa-IR', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    });
};

// Sorter سفارشی برای اعداد
numericSorter = function(a, b) {
    return extractNumberFromValue(a) - extractNumberFromValue(b);
};

$(function () {
    // فعال‌سازی جدول
    $('#table').bootstrapTable();

    // کلیک روی سطر → باز کردن لینک
    $('#table tbody').on('click', 'tr[data-href]', function() {
        var href = $(this).data('href');
        var target = $(this).data('target') || '_self';
        window.open(href, target);
    });
});
</script>
{% endblock %}


