{% extends 'shared/_MainLayout.html' %}
{% load humanize %}
{% load static %}
{% block content %}
    {% load jalali_tags %}
    {% load custom_filters %}

    <div class="content-wrapper">
        <div class="page-title">
            <div class="row">
                <div class="col-sm-6">
                    <div class="d-block">
                        <h5 class="card-title text-facebook pb-0 border-0">
                            {{ hesabmoshtari.person.name }} {{ hesabmoshtari.person.lname }}
                            {% if hesabmoshtari.total_mandeh > 0 %}
                                <span class="badge badge-pill badge-success">ÿ®ÿ≥ÿ™ÿßŸÜ⁄©ÿßÿ±</span>
                            {% elif hesabmoshtari.total_mandeh == 0 %}
                                <span class="badge badge-pill badge-primary">ÿ®€å ÿ≠ÿ≥ÿßÿ®</span>
                            {% elif hesabmoshtari.total_mandeh < 0 %}
                                <span class="badge badge-pill badge-danger">ÿ®ÿØŸá⁄©ÿßÿ±</span>
                            {% endif %}
                        </h5>
                    </div>

                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb pt-0 pr-0 float-left float-sm-right">
                        <li class="breadcrumb-item"><a href="/" class="default-color"> ÿÆÿßŸÜŸá</a></li>
                        <li class="breadcrumb-item active">ÿ≠ÿ≥ÿßÿ® ŸÖÿ¥ÿ™ÿ±€å</li>
                        <li class="breadcrumb-item active">
                            {{ hesabmoshtari.person.lname }} {{ hesabmoshtari.person.name }}
                        </li>

                    </ol>
                </div>
            </div>


            <!-- ÿ±ÿØ€åŸÅ ÿØÿ±ÿ®ÿßÿ±Ÿá ŸÖÿ¥ÿ™ÿ±€å -->
            <div class="row">
                <div class="col-xl-12 mb-30">
                    <div class="card mb-30 about-me">
                        <div class="card-body">
                            <h5 class="card-title">ÿßÿ∑ŸÑÿßÿπÿßÿ™ ÿ∑ÿ±ŸÅ ÿ≠ÿ≥ÿßÿ®</h5>

                            {% with person=hesabmoshtari.person amani_list=amani %}
                                {% if person %}
                                    <!-- ŸÜŸÖÿß€åÿ¥ ŸÜÿßŸÖ ÿ®ÿß Ÿæ€åÿ¥ŸàŸÜÿØ -->
                                    <p class="font-weight-bold">
                                        {% if person.prefix %}{{ person.prefix }} {% endif %}
                                        {{ person.clname }}
                                    </p>

                                    <ul class="list-unstyled" style="text-align: right; direction: rtl;">
                                        {# ŸÖŸàÿ®ÿß€åŸÑ #}
                                        {% if person.mobile %}
                                            <li class="list-item d-flex align-items-center" style="margin-bottom: 8px;">
                                                <span class="ti-mobile text-success ml-2"
                                                      style="font-size: 1.2em;"></span>
                                                <span>{{ person.mobile }}</span>
                                            </li>
                                        {% endif %}

                                        {# ÿ™ŸÑŸÅŸÜ 1 #}
                                        {% if person.tel1 %}
                                            <li class="list-item d-flex align-items-center" style="margin-bottom: 8px;">
                                                <span class="ti-headphone-alt text-primary ml-2"
                                                      style="font-size: 1.2em;"></span>
                                                <span>{{ person.tel1 }}</span>
                                            </li>
                                        {% endif %}

                                        {# ÿ™ŸÑŸÅŸÜ 2 #}
                                        {% if person.tel2 %}
                                            <li class="list-item d-flex align-items-center" style="margin-bottom: 8px;">
                                                <span class="ti-headphone-alt text-primary ml-2"
                                                      style="font-size: 1.2em;"></span>
                                                <span>{{ person.tel2 }}</span>
                                            </li>
                                        {% endif %}

                                        {# ŸÅ⁄©ÿ≥ #}
                                        {% if person.fax %}
                                            <li class="list-item d-flex align-items-center" style="margin-bottom: 8px;">
                                                <span class="ti-printer text-muted ml-2"
                                                      style="font-size: 1.2em;"></span>
                                                <span>{{ person.fax }}</span>
                                            </li>
                                        {% endif %}

                                        {# ÿß€åŸÖ€åŸÑ ‚Äî ÿ™ÿ¥ÿÆ€åÿµ ÿßÿ≤ ÿ∑ÿ±€åŸÇ @ #}
                                        {% if person.comname and "@" in person.comname %}
                                            <li class="list-item d-flex align-items-center" style="margin-bottom: 8px;">
                                                <span class="ti-email text-info ml-2" style="font-size: 1.2em;"></span>
                                                <span>{{ person.comname }}</span>
                                            </li>
                                        {% endif %}

                                        {# ŸÜÿßŸÖ ÿ¥ÿ±⁄©ÿ™ / ŸÖÿπÿ±ŸÅ #}
                                        {% if person.comname and "@" not in person.comname %}
                                            <li class="list-item d-flex align-items-center" style="margin-bottom: 8px;">
                                                <span class="ti-briefcase text-warning ml-2"
                                                      style="font-size: 1.2em;"></span>
                                                <span>{{ person.comname }}</span>
                                            </li>
                                        {% endif %}

                                        {# ⁄©ÿØ ŸÖÿπÿ±ŸÅ #}
                                        {% if person.identifier %}
                                            <li class="list-item d-flex align-items-center" style="margin-bottom: 8px;">
                                                <span class="ti-id-badge text-dark ml-2"
                                                      style="font-size: 1.2em;"></span>
                                                <span>⁄©ÿØ ŸÖÿπÿ±ŸÅ: {{ person.identifier }}</span>
                                            </li>
                                        {% endif %}

                                        {# ÿ¢ÿØÿ±ÿ≥ 1 #}
                                        {% if person.address %}
                                            <li class="list-item d-flex align-items-center" style="margin-bottom: 8px;">
                                                <span class="ti-location-pin text-danger ml-2"
                                                      style="font-size: 1.2em;"></span>
                                                <span>{{ person.address }}</span>
                                            </li>
                                        {% endif %}

                                        {# ÿ¢ÿØÿ±ÿ≥ 2 #}
                                        {% if person.address2 %}
                                            <li class="list-item d-flex align-items-center" style="margin-bottom: 8px;">
                                                <span class="ti-location-pin text-danger ml-2"
                                                      style="font-size: 1.2em;"></span>
                                                <span>{{ person.address2 }}</span>
                                            </li>
                                        {% endif %}

                                        {# ÿ™Ÿàÿ∂€åÿ≠ÿßÿ™ ÿ¥ÿÆÿµ #}
                                        {% if person.comment %}
                                            <li class="list-item d-flex align-items-center" style="margin-bottom: 8px;">
                                                <span class="ti-comments-smiley text-secondary ml-2"
                                                      style="font-size: 1.2em;"></span>
                                                <span>{{ person.comment|truncatechars:100 }}</span>
                                            </li>
                                        {% endif %}

                                        {# ÿ™Ÿàÿ∂€åÿ≠ÿßÿ™ ÿ≠ŸàÿßŸÑŸá‚ÄåŸáÿß€å ÿßŸÖÿßŸÜ€å (amani) #}
                                        {% for item in amani_list %}
                                            {% if item.comment %}
                                                <li class="list-item d-flex align-items-center"
                                                    style="margin-bottom: 8px;">
                                                    <span class="ti-package text-info ml-2"
                                                          style="font-size: 1.2em;"></span>
                                                    <span>ÿ™Ÿàÿ∂€åÿ≠ÿßÿ™ ÿßŸÖÿßŸÜ€å (ÿ≠ŸàÿßŸÑŸá {{ item.code }}): {{ item.comment|truncatechars:100 }}</span>
                                                </li>
                                            {% endif %}
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    <p>ÿßÿ∑ŸÑÿßÿπÿßÿ™ ÿ∑ÿ±ŸÅ ÿ≠ÿ≥ÿßÿ® €åÿßŸÅÿ™ ŸÜÿ¥ÿØ.</p>
                                {% endif %}
                            {% endwith %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- ÿ±ÿØ€åŸÅ ÿßŸàŸÑ ÿÆŸÑÿßÿµŸá Ÿáÿß -->
            <div class="row">
                <div class="col-xl-3 col-lg-6 col-md-6 mb-30">
                    <div class="card card-statistics h-100">
                        <div class="card-body">
                            <div class="clearfix">
                                <div class="float-left icon-box bg-primary rounded-circle">
    <span class="text-white">
    <i class="fa fa-dollar highlight-icon" aria-hidden="true"></i>
    </span>
                                </div>
                                <div class="float-right text-right">
                                    <p class="card-text text-dark">ŸÖÿßŸÜÿØŸá ÿ≠ÿ≥ÿßÿ®</p>
                                    <h4 style="direction: ltr">{{ hesabmoshtari.total_mandeh|floatformat:0|intcomma:False }}</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-lg-6 col-md-6 mb-30">
                    <div class="card card-statistics h-100">
                        <div class="card-body">
                            <div class="clearfix">
                                <div class="float-left icon-box bg-pinterest rounded-circle">
    <span class="text-white">
    <i class="fa fa-hourglass-end highlight-icon" aria-hidden="true"></i>
    </span>
                                </div>
                                <div class="float-right text-right">
                                    <p class="card-text text-dark"> ÿ¢ÿÆÿ±€åŸÜ Ÿæÿ±ÿØÿßÿÆÿ™€å </p>
                                    <h4> {{ hesabmoshtari.from_last_daryaft|floatformat:0|intcomma:False }} ÿ±Ÿàÿ≤ ŸÇÿ®ŸÑ</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-lg-6 col-md-6 mb-30">
                    <div class="card card-statistics h-100">
                        <div class="card-body">
                            <div class="clearfix">
                                <div class="float-left icon-box bg-success rounded-circle">
    <span class="text-white">
    <i class="fa  fa-bar-chart-o highlight-icon" aria-hidden="true"></i>
    </span>
                                </div>
                                <div class="float-right text-right">
                                    <p class="card-text text-dark"> ŸÖÿ™Ÿàÿ≥ÿ∑ ŸÖÿßŸÜÿØŸá ÿ≠ÿ≥ÿßÿ® </p>
                                    <h4 style="direction: ltr">{{ ave|floatformat:0|intcomma:False }}</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-lg-6 col-md-6 mb-30">
                    <div class="card card-statistics h-100">
                        <div class="card-body">
                            <div class="clearfix">
                                <div class="float-left icon-box bg-secondary rounded-circle">
    <span class="text-white">
    <i class="fa fa-calendar-check-o highlight-icon" aria-hidden="true"></i>
    </span>
                                </div>
                                <div class="float-right text-right">
                                    <p class="card-text text-dark"> ÿ™ÿπÿØÿßÿØ ÿ±Ÿàÿ≤ Ÿáÿß </p>
                                    <h4 style="direction: ltr">{{ acc_days|floatformat:0|intcomma:False }}</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-lg-6 col-md-6 mb-30">
                    <div class="card card-statistics h-100">
                        <div class="card-body">
                            <div class="clearfix">
                                <div class="float-left icon-box {% if khab %} bg-danger {% else %} bg-facebook {% endif %}   rounded-circle">
    <span class="text-white">
    <i class="fa fa-calculator highlight-icon" aria-hidden="true"></i>
    </span>
                                </div>
                                <div class="float-right text-right">
                                    {% if khab %}
                                        <p class="card-text text-dark"> ÿ®ÿßÿ± ŸÖÿßŸÑ€å ÿ®ÿØŸá€å </p>
                                    {% else %}
                                        <p class="card-text text-dark"> ÿ®ÿßÿ± ŸÖÿßŸÑ€å ÿ∑ŸÑÿ® </p>
                                    {% endif %}
                                    <h4> {{ bar_mali|intword }} ÿ±€åÿßŸÑ </h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


            </div>
            <!-- ÿ±ÿØ€åŸÅ ŸÜŸÖŸàÿØÿßÿ± -->

            <div class="row">
                <div class="col-md-12 mb-30">
                    <div class="col-xl-12 mb-30">
                        <div class="card card-statistics h-100">
                            <div class="card-body">
                                <div class="table-responsive mt-15 ">
                                    <h5 class="card-title pb-0 border-0">ŸÜŸÖŸàÿØÿßÿ± ⁄Øÿ±ÿØÿ¥ ÿ≠ÿ≥ÿßÿ®</h5>
                                </div>

                                <div class="chart-container ">
                                    <canvas id="Chart1" style="height: 400px; width: 100%;"></canvas>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- ÿ±ÿØ€åŸÅ ÿÆŸÑÿßÿµŸá Ÿà ÿ¨ÿ≤ÿ¶€åÿßÿ™ ŸàÿßŸÖ Ÿáÿß -->
            <div class="row">
                <div class="col-md-5 mb-30">
                    <div class="card card-statistics h-100">
                        <div class="card-body col-12">
                            <h5 class="card-title pb-0 border-0 ">ÿÆŸÑÿßÿµŸá ÿßŸÇÿ≥ÿßÿ∑</h5>
                            <div class="table-responsive">
                                <table class="table center-aligned-table mb-10 text-center ">
                                    <thead>
                                    <tr class="text-dark">
                                        <th>ÿ±ÿØ€åŸÅ</th>
                                        <th>⁄©ÿØ ÿßŸÇÿ≥ÿßÿ∑</th>
                                        <th>ÿ™ÿßÿ±€åÿÆ ÿßŸÇÿ≥ÿßÿ∑</th>
                                        <th>ÿ™ÿπÿØÿßÿØ ÿßŸÇÿ≥ÿßÿ∑</th>
                                        <th>ŸÖÿ®ŸÑÿ∫ ÿßŸàŸÑ€åŸá</th>
                                        <th>ÿ®ÿßŸÇ€åŸÖÿßŸÜÿØŸá</th>
                                        <th>ŸÖÿπŸàŸÇ</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for loan in hesabmoshtari.loans.all %}
                                        <tr>
                                            <td><h6>{{ forloop.counter }}</h6></td>
                                            <td><h6>{{ loan.code }}</h6></td>
                                            <td><h6>{{ loan.tarikh }}</h6></td>
                                            <td><h6>{{ loan.number }}</h6></td>
                                            <td><h6>{{ loan.cost|floatformat:0|intcomma:False }}</h6></td>
                                            <td><h6>{{ loan.actual_loan_mandeh|floatformat:0|intcomma:False }}</h6></td>
                                            <td><h6>{{ loan.delayed_loan|floatformat:0|intcomma:False }}</h6></td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>


                <div class="col-md-7 mb-30">
                    <div class="card card-statistics h-100">
                        <div class="card-body">
                            <h5 class="card-title pb-0 border-0 ">ÿ¨ÿ≤ÿ¶€åÿßÿ™ ÿßŸÇÿ≥ÿßÿ∑</h5>
                            <div class="table-responsive scrollbar max-h-380">
                                {% for loan in hesabmoshtari.loans.all %}
                                    <div class="table-responsive">
                                        <table class="table center-aligned-table mb-10 text-center ">
                                            <thead>
                                            <tr class="text-dark">
                                                <th>⁄©ÿØ ŸÇÿ≥ÿ∑</th>
                                                <th>ÿ¥ŸÖÿßÿ±Ÿá ŸÇÿ≥ÿ∑</th>
                                                <th>ÿ™ÿßÿ±€åÿÆ</th>
                                                <th> ÿ™ÿßÿ±€åÿÆ ÿØÿ±€åÿßŸÅÿ™</th>
                                                <th>ŸÖÿ®ŸÑÿ∫</th>
                                                <th>ÿØÿ±ÿµÿØ Ÿæÿ±ÿØÿßÿÆÿ™</th>
                                                <th>Ÿàÿ∂ÿπ€åÿ™</th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                            {% for lo in loan.loandetil_set.all %}
                                                <tr>
                                                    <td>{{ loan.code }}</td>
                                                    <td>{{ lo.row }}</td>
                                                    <td>{{ lo.tarikh }}</td>
                                                    <td>{{ lo.recive_tarikh }}</td>
                                                    <td>{{ lo.cost|floatformat:0|intcomma:False }}</td>
                                                    <td>{{ lo.complete_percent|percentage }}%</td>
                                                    <td>
                                                        {% if lo.complete_percent == 1 %}
                                                            {% if lo.date < today %}
                                                                <span class="btn btn-sm btn-success">Ÿæÿßÿ≥</span>
                                                            {% else %}
                                                                <span class="btn btn-sm btn-info">ÿ™ÿπÿ¨€åŸÑ</span>
                                                            {% endif %}
                                                        {% elif lo.date < today %}
                                                            <span class="btn btn-sm btn-danger">ŸÖÿπŸàŸÇ</span>
                                                        {% else %}
                                                            <span class="btn btn-sm btn-primary">ÿπÿßÿØ€å</span>
                                                        {% endif %}
                                                    </td>

                                                </tr>
                                            {% endfor %}

                                            </tbody>
                                        </table>
                                    </div>
                                {% endfor %}

                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- ÿ±ÿØ€åŸÅ ⁄Ü⁄©Ÿáÿß€å ÿØÿ±€åÿßŸÅÿ™€å  -->
            <div class="row">
                <div class="col-md-5 mb-30">
                    <div class="card card-statistics h-100">
                        <div class="card-body col-12">
                            <h5 class="card-title pb-0 border-0 ">⁄Ü⁄©Ÿáÿß€å ÿØÿ±€åÿßŸÅÿ™ŸÜ€å</h5>
                            <div class="table-responsive">
                                <table class="table center-aligned-table mb-10 text-center ">
                                    <thead>
                                    <tr class="text-dark">
                                        <th>ÿ¥ŸÜÿßÿ≥Ÿá ⁄Ü⁄©</th>
                                        <th>ÿ≥ÿ± ÿ±ÿ≥€åÿØ</th>
                                        <th>ÿ®ÿßŸÜ⁄©</th>
                                        <th>ÿ¥ÿπÿ®Ÿá</th>
                                        <th>ŸÖÿ®ŸÑÿ∫</th>
                                        <th>ŸÖÿßŸÜÿØŸá</th>
                                        <th>ÿ±Ÿàÿ≤ ÿ™ÿß ÿ≥ÿ±ÿ±ÿ≥€åÿØ</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for cheque in chequ_recive %}
                                        <tr>
                                            <td><h6>{{ cheque.cheque_id }}</h6></td>
                                            <td><h6>{{ cheque.cheque_tarik }}</h6></td>
                                            <td><h6>{{ cheque.bank_name }}</h6></td>
                                            <td><h6>{{ cheque.bank_branch }}</h6></td>
                                            <td><h6>{{ cheque.cost|floatformat:0|intcomma:False }}</h6></td>
                                            <td><h6 style="direction: ltr">{{ cheque.total_mandeh|floatformat:0|intcomma:False }}</h6></td>
                                            <td>
                                                {% if cheque.cheque_date > today  %}
                                                <h6 class="text-success">{{ cheque.cheque_date|timeuntil }}</h6>
                                                {% else %}
                                                <h6 class="text-danger">{{ cheque.cheque_date|timesince }}</h6>
                                                    <i class="fas fa-exclamation-triangle blink"></i>
                                                {% endif %}




                                            </td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>


            </div>





            <!-- ÿ±ÿØ€åŸÅ Ÿæ€å⁄Ø€åÿ±€å Ÿæ€å⁄Ø€åÿ±€å -->
            <div class="row">
                <!-- ÿ±ÿØ€åŸÅ Ÿæ€åÿßŸÖ⁄© -->
                <div class="col-xl-4 mb-30">
                    <div class="card card-statistics h-100">
                        <div class="p-4 text-center bg-success">
                            <h5 class="mb-60 text-white"></h5>
                        </div>
                        <div class="card-body text-center">
                            <div class="avatar-top">
                                <img class="img-fluid w-25 rounded-circle " src="{% static 'images/noimage.png' %}"
                                     alt="">
                            </div>
                            <h5 class="card-title text-facebook pb-0 border-0">{{ hesabmoshtari.person.clname }}</h5>
                            <div class="card-body">
                                <div class="clearfix">
                                    <div class="float-left icon-box bg-success rounded-circle">
                  <span class="text-white">
                    <i class="fa fa-envelope highlight-icon" aria-hidden="true"></i>
                  </span>
                                    </div>
                                    <div class="float-right text-right">
                                        <h4>Ÿæ€å⁄Ø€åÿ±€å Ÿæ€åÿßŸÖ⁄©€å</h4>
                                    </div>
                                </div>
                            </div>

                            <div class="social-icons color-icon mt-20">
                                <ul>
                                    {% if gh in hesabmoshtari.person %}
                                        <li class="social-rss"><a href="#"><i class="fa fa-rss"></i></a></li>
                                    {% endif %}
                                    {#                    <li class="social-facebook"><a href="#"><i class="fa fa-facebook"></i></a></li>#}
                                    {#                    <li class="social-twitter"><a href="#"><i class="fa fa-twitter"></i></a></li>#}
                                    {#                    <li class="social-github"><a href="#"><i class="fa fa-github"></i></a></li>#}
                                    {#                    <li class="social-youtube"><a href="#"><i class="fa fa-youtube"></i></a></li>#}
                                    {#                    <li class="social-instagram"><a href="#"><i class="fa fa-instagram"></i></a></li>#}
                                </ul>
                            </div>
                            <form method="POST">
                                {% csrf_token %}
                                {{ sms_form.as_p }}
                                <button type="submit" name="action" value="send_sms" class="btn btn-success">ÿßÿ±ÿ≥ÿßŸÑ Ÿæ€åÿßŸÖ⁄©
                                </button>
                            </form>


                            {#               <div class="divider mt-20"></div>#}
                            {#               <div class="row">#}
                            {#                  <div class="col-6 col-sm-4 mt-30">#}
                            {#                     <b>Ÿæÿ±Ÿà⁄òŸá</b>#}
                            {#                     <h4 class="text-success mt-10">09</h4>#}
                            {#                  </div>#}
                            {#                  <div class="col-6 col-sm-4 mt-30">#}
                            {#                    <b>Ÿæ€åÿßŸÖ Ÿáÿß </b>#}
                            {#                     <h4 class="text-danger mt-10">255</h4>#}
                            {#                  </div>#}
                            {#                  <div class="col-12 col-sm-4 mt-30">#}
                            {#                    <b>ŸÜŸÖÿß€åÿ¥ Ÿáÿß</b>#}
                            {#                     <h4 class="text-warning mt-10">608</h4>#}
                            {#                  </div>#}
                            {#                </div>#}
                        </div>
                    </div>
                </div>
                <!-- ÿ±ÿØ€åŸÅ ÿ™ŸÑŸÅŸÜ -->
                <div class="col-xl-4 mb-30">
                    <div class="card card-statistics h-100">
                        <div class="p-4 text-center bg-primary">
                            <h5 class="mb-60 text-white"></h5>
                        </div>
                        <div class="card-body text-center">
                            <div class="avatar-top">
                                <img class="img-fluid w-25 rounded-circle " src="{% static 'images/noimage.png' %}"
                                     alt="">
                            </div>
                            <h5 class="card-title text-facebook pb-0 border-0">{{ hesabmoshtari.person.clname }}</h5>
                            <div class="card-body">
                                <div class="clearfix">
                                    <div class="float-left icon-box bg-primary rounded-circle">
                  <span class="text-white">
                    <i class="fa fa-phone highlight-icon" aria-hidden="true"></i>
                  </span>
                                    </div>
                                    <div class="float-right text-right">
                                        <h4>Ÿæ€å⁄Ø€åÿ±€å ÿ™ŸÑŸÅŸÜ€å</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="social-icons color-icon mt-20">
                                <ul>
                                    {% if gh in hesabmoshtari.person %}
                                        <li class="social-rss"><a href="#"><i class="fa fa-rss"></i></a></li>
                                    {% endif %}
                                </ul>
                            </div>
                            <form method="POST">
                                {% csrf_token %}

                                <!-- ÿ¥ŸÖÿßÿ±Ÿá ÿ™ŸÑŸÅŸÜ -->
                                <label for="id_phone_number">ÿ¥ŸÖÿßÿ±Ÿá ÿ™ŸÑŸÅŸÜ:</label>
                                {{ call_form.phone_number }}

                                <!-- ÿØ⁄©ŸÖŸá ÿ¥ÿ±Ÿàÿπ ÿ™ŸÖÿßÿ≥ (ÿØÿ±ÿ≥ÿ™ ÿ®ÿπÿØ ÿßÿ≤ ÿ¥ŸÖÿßÿ±Ÿá ÿ™ŸÑŸÅŸÜ) -->
                                <button type="button" id="start_call" class="btn btn-success mt-3">ÿ¥ÿ±Ÿàÿπ ÿ™ŸÖÿßÿ≥ (0s)
                                </button>
                                <!-- ÿØ⁄©ŸÖŸá ÿßŸÜÿµÿ±ÿßŸÅ -->
                                <button type="button" id="cancel_call" class="btn btn-secondary mt-3">ÿßŸÜÿµÿ±ÿßŸÅ ÿ™ŸÖÿßÿ≥
                                </button>
                                <br>
                                <br>
                                <!-- ÿ≥ÿß€åÿ± ŸÅ€åŸÑÿØŸáÿß€å ŸÅÿ±ŸÖ -->
                                <label for="id_call_status">Ÿàÿ∂ÿπ€åÿ™ ÿ™ŸÖÿßÿ≥:</label>
                                {{ call_form.call_status }}

                                <label for="id_call_description">ÿ¥ÿ±ÿ≠ ÿ™ŸÖÿßÿ≥:</label>
                                {{ call_form.call_description }}

                                <label for="id_next_reminder_date">ÿ≤ŸÖÿßŸÜ Ÿæ€å⁄Ø€åÿ±€å ÿ®ÿπÿØ€å:</label>
                                {{ call_form.next_reminder_date }}

                                <input type="hidden" id="call_duration" name="call_duration" value="0">

                                <button type="submit" name="action" value="track_call" class="btn btn-primary mt-3">ÿ´ÿ®ÿ™
                                    ⁄Øÿ≤ÿßÿ±ÿ¥ ÿ™ŸÖÿßÿ≥
                                </button>
                            </form>

                        </div>
                    </div>
                </div>
                <!-- ÿ±ÿØ€åŸÅ ÿ∑ŸÑÿß€å ÿßŸÖÿßŸÜ€å -->
                {% if amani %}
                    <div class="col-xl-4 mb-30">
                        <div class="card card-statistics h-100">
                            <div class="p-4 text-center bg-warning">
                                <h5 class="mb-60 text-white"></h5>
                            </div>
                            <div class="card-body text-center">
                                <div class="avatar-top">
                                    <img class="img-fluid w-25 rounded-circle "
                                         src="{% static 'images/gold_baskt.jpg' %}"
                                         alt="">
                                </div>
                                <div class="card-body">
                                    <div class="clearfix">
                                        <div class="float-left icon-box bg-warning rounded-circle">
                  <span class="text-white">
                    <i class="fa fa-lock highlight-icon" aria-hidden="true"></i>
                  </span>
                                        </div>
                                        <div class="float-right text-right">
                                            <h4>ŸÑ€åÿ≥ÿ™ ÿ∑ŸÑÿß€å ÿßŸÖÿßŸÜ€å</h4>
                                        </div>
                                    </div>
                                </div>
                                <table class="table center-aligned-table mb-0">
                                    <thead>
                                    <tr class="text-dark">
                                        <th>ÿ±ÿØ€åŸÅ</th>
                                        <th>⁄©ÿØ ÿ≠ŸàÿßŸÑŸá</th>
                                        <th>Ÿàÿ≤ŸÜ</th>
                                        <th>ÿ™ÿßÿ±€åÿÆ</th>
                                        <th>ÿ™Ÿàÿ∂€åÿ≠ÿßÿ™</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for a in amani %}
                                        <tr>
                                            <td>{{ forloop.counter }}</td>
                                            <td>{{ a.code }}</td>
                                            <td>{{ a.amount1|floatformat:2 }}</td>
                                            <td>{{ a.p_date }}</td>
                                            <td>{{ a.comment }}</td>

                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>

                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>


            <!-- ÿ±ÿØ€åŸÅ ⁄Øÿ≤ÿßÿ±ÿ¥ ÿßŸÇÿ≥ÿßÿ∑ -->
            <div class="row">

                <div class="col-xl-12 mb-30">
                    <div class="card card-statistics h-100">
                        <div class="card-body">
                            <h5 class="card-title pb-0 border-0">ÿ¢ÿÆÿ±€åŸÜ Ÿæ€å⁄Ø€åÿ±€å Ÿáÿß </h5>
                            <h5 class="card-title pb-0 border-0 text-warning">Ÿæ€å⁄Ø€åÿ±€å
                                ÿ®ÿπÿØ€å{{ tracking.first.next_reminder_date|timeuntil }} ÿØ€å⁄Øÿ± </h5>
                            <div class="table-responsive scrollbar max-h-500">
                                <div class="table-responsive">


                                    <table class="table center-aligned-table mb-0">
                                        <thead>
                                        <tr class="text-dark">
                                            <th>ÿ±ÿØ€åŸÅ</th>
                                            <th>ÿßŸÇÿØÿßŸÖ ⁄©ŸÜŸÜÿØŸá</th>
                                            <th>ŸÜŸàÿπ Ÿæ€å⁄Ø€åÿ±€å</th>
                                            <th>Ÿàÿ∂ÿπ€åÿ™</th>
                                            <th>ÿ≤ŸÖÿßŸÜ</th>
                                            <th>ÿ≥ÿ∑ÿ≠ Ÿæ€åÿßŸÖ⁄©</th>
                                            <th>ÿ¥ÿ±ÿ≠</th>
                                            <th>ÿ™ŸÑŸÅŸÜ</th>
                                            {#            <th>Ÿæ€å⁄Ø€åÿ±€å ÿ®ÿπÿØ€å</th>#}
                                        </tr>
                                        </thead>
                                        <tbody>
                                        {% for t in tracking %}
                                            <tr>
                                                <td>{{ forloop.counter }}</td>
                                                <td>
                                                    {% if t.created_by %}
                                                        <img class="img-fluid avatar-small"
                                                             src="{{ t.created_by.avatar.url }}" alt="">
                                                    {% else %}
                                                        -
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if t.call_status == 4 %}
                                                        <i class="fa fa-hourglass-start text-warning fa-2x"></i>

                                                    {% else %}
                                                        <i class="fa {{ t.track_kind.kind_icon }} text-{{ t.track_kind.kind_color }} fa-2x"></i>
                                                    {% endif %}
                                                </td>

                                                <!-- Ÿàÿ∂ÿπ€åÿ™ Ÿæ€åÿßŸÖ⁄© €åÿß ÿ™ŸÖÿßÿ≥ -->
                                                <td>

                                                    {% if t.track_kind.is_call_related %}
                                                        <span class="{{ t.get_call_status_details.color }}">
                        <i class="fa {{ t.get_call_status_details.icon }}"></i>
                        {{ t.get_call_status_details.persian }}
                    </span>
                                                    {% else %}
                                                        <span class="{{ t.get_status_details.color }}">
                        <i class="fa {{ t.get_status_details.icon }}"></i>
                        {{ t.get_status_details.persian }}
                    </span>
                                                    {% endif %}
                                                </td>

                                                <td>{{ t.created_at|to_jalali:"%Y/%m/%d - %H:%M" }}</td>
                                                <td>{{ t.sample_sms.level|default:"-" }}</td>

                                                <!-- ŸÜŸÖÿß€åÿ¥ ÿ¥ÿ±ÿ≠ ÿ™ŸÖÿßÿ≥ €åÿß Ÿæ€åÿßŸÖ⁄© -->
                                                <td>
                                                    {% if t.track_kind.is_call_related %}
                                                        {{ t.call_description|default:"-" }}
                                                    {% else %}
                                                        {{ t.message_to_send|default:"-" }}
                                                    {% endif %}
                                                </td>

                                                <td>{{ t.phone_number|default:"-" }}</td>
                                                {#            <td>{{ t.next_reminder_date|timeuntil }}</td>#}
                                            </tr>
                                        {% endfor %}
                                        </tbody>
                                    </table>


                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>


            <!-- ÿ±ÿØ€åŸÅ ÿ¨ÿ≤ÿ¶€åÿßÿ™ ÿßÿ≥ŸÜÿßÿØ -->
            <div class="row">
                <div class="col-md-12 mb-30">
                    <div class="col-xl-12 mb-30">
                        <div class="card card-statistics h-100">
                            <div class="card-body">
                                <div class="table-responsive mt-15 ">
                                    <h6 class="card-title pb-0 border-0">ŸÖÿßŸÜÿØŸá
                                        ÿ≠ÿ≥ÿßÿ® {{ hesabmoshtari.person.name }} {{ hesabmoshtari.person.lname }} :</h6>
                                    <h5 class="card-title pb-0 border-0"><span id="total-mandah"
                                                                               class="text-primary"></span>
                                        ÿ±€åÿßŸÑ </h5>
                                    <div class="table-responsive">
                                        <table id="table"
                                               class="table-striped"
                                               data-toggle="table"
                                               data-locale="fa-IR"
                                               data-search="true"
                                               data-show-columns="true"
                                               data-show-export="true"
                                               data-show-refresh="true"
                                               data-show-columns-toggle-all="true"
                                               data-show-pagination-switch="true"
                                               data-show-toggle="true"
                                               data-show-fullscreen="true"
                                               data-buttons="buttons"
                                               data-search-align="left"
                                               data-buttons-class="primary"
                                               data-pagination="true"
                                               data-show-columns-search="true"
                                               data-show-footer="true"
                                               data-page-size="10"
                                               data-remember-order="true"
                                               data-sortable="true"
                                               data-show-search-clear-button="true"
                                                {#                                                   data-sort-name="date"#}
                                               data-sort-order="asc"
                                               data-filter-control="true"
                                               data-show-print="true"
                                               data-export-data-type="all"
                                               data-export-types='["excel"]'>
                                            <thead>
                                            <tr class="tr-class-1">
                                                <th class="card-text text-center" data-sortable="true"
                                                    data-field="code"
                                                    data-filter-control="input">⁄©ÿØ
                                                </th>
                                                <th class="card-text text-center" data-sortable="true"
                                                    data-field="radif"
                                                    data-filter-control="input">ÿ±ÿØ€åŸÅ
                                                </th>
                                                <th class="card-text text-center" data-sortable="true"
                                                    data-field="date"
                                                    data-filter-control="select">ÿ™ÿßÿ±€åÿÆ
                                                </th>
                                                <th class="card-text text-center" data-sortable="true"
                                                    data-field="kind" data-filter-control="select">ŸÜŸàÿπ
                                                </th>
                                                <th class="card-text text-center" data-sortable="true"
                                                    data-field="sharh"
                                                    data-filter-control="input">ÿ¥ÿ±ÿ≠ ÿ≥ŸÜÿØ
                                                </th>
                                                <th class="card-text text-center" data-sortable="true"
                                                    data-field="bed" data-footer-formatter="priceFormatter">ÿ®ÿØŸá⁄©ÿßÿ±
                                                </th>
                                                <th class="card-text text-center" data-sortable="true"
                                                    data-field="bes" data-footer-formatter="priceFormatter">ÿ®ÿ≥ÿ™ÿßŸÜ⁄©ÿßÿ±
                                                </th>
                                                <th class="card-text text-center" data-sortable="true"
                                                    data-field="mandeh">ŸÖÿßŸÜÿØŸá ⁄©ŸÑ
                                                </th>
                                                {#                                                <th class="card-text text-center" data-sortable="true"#}
                                                {#                                                    data-field="mandkol"#}
                                                {#                                                    data-filter-control="select">ŸÖÿßŸÜÿØŸá ⁄©ŸÑ#}
                                                {#                                                </th>#}

                                            </tr>
                                            </thead>
                                            <tbody>
                                            {% for s in asnad_table %}
                                                <tr>
                                                    <td class="card-text text-center">{{ s.code }}</td>
                                                    {#                                                    <td class="card-text text-center">{{ s.radif }}</td>#}
                                                    <td class="card-text text-center">{{ s.acc_year }}</td>
                                                    <td class="card-text text-center">{{ s.tarikh }}</td>
                                                    {#                                                    <td class="card-text text-center ">{{ s.kind.0 }}</td>#}
                                                    <td class="card-text text-center text-{{ s.kind.2 }}">{{ s.kind.1 }}</td>
                                                    {#                                                     <td class="card-text text-center ">{{ s.syscomment }}</td>#}
                                                    <td class="card-text text-center ">
                                                        {% if s.syscomment %}
                                                            {{ s.syscomment }}
                                                        {% else %}
                                                            {{ s.sharh }}
                                                        {% endif %}
                                                    </td>

                                                    <td class="card-text text-center">{{ s.bed|floatformat:0|intcomma:False }}</td>
                                                    <td class="card-text text-center">{{ s.bes|floatformat:0|intcomma:False }}</td>
                                                    <td class="card-text text-center"
                                                        style="direction: ltr">{{ s.mandeh|floatformat:0|intcomma:False }}</td>
                                                    {#                                                    <td class="card-text text-center"></td>#}
                                                </tr>
                                            {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>


                            </div>
                        </div>
                    </div>
                </div>
            </div>


        </div>


    </div>


{% endblock %}





{% block myjs %}
    <script>
        document.getElementById("start_call").addEventListener("click", function () {
            let button = this;

            if (button.classList.contains("btn-success")) {
                button.textContent = "Ÿæÿß€åÿßŸÜ ÿ™ŸÖÿßÿ≥ (0s)";
                button.classList.remove("btn-success");
                button.classList.add("btn-danger");

                let counter = 0;
                let timer = setInterval(() => {
                    counter++;
                    document.getElementById("call_duration").value = counter;
                    button.textContent = `Ÿæÿß€åÿßŸÜ ÿ™ŸÖÿßÿ≥ (${counter}s)`; // üîπ ŸÜŸÖÿß€åÿ¥ ÿ´ÿßŸÜ€åŸá ÿØÿßÿÆŸÑ ÿØ⁄©ŸÖŸá
                }, 1000);

                button.setAttribute("data-timer", timer);

                let phoneNumber = document.getElementById("id_phone_number").value;
                window.location.href = `tel:${phoneNumber}`;

            } else {
                clearInterval(button.getAttribute("data-timer"));
                button.classList.remove("btn-danger");
                button.classList.add("btn-secondary");
                button.textContent = `ÿ™ŸÖÿßÿ≥ Ÿæÿß€åÿßŸÜ €åÿßŸÅÿ™ (${document.getElementById("call_duration").value}s)`;
            }
        });

        // üõ† ÿØ⁄©ŸÖŸá ÿßŸÜÿµÿ±ÿßŸÅ -> ÿ™ŸÜÿ∏€åŸÖ ÿ≤ŸÖÿßŸÜ ÿ™ŸÖÿßÿ≥ ÿ®Ÿá ÿµŸÅÿ± Ÿà Ÿæÿß⁄© ⁄©ÿ±ÿØŸÜ ÿ¥ÿ±ÿ≠ ÿ™ŸÖÿßÿ≥
        document.getElementById("cancel_call").addEventListener("click", function () {
            clearInterval(document.getElementById("start_call").getAttribute("data-timer"));
            document.getElementById("call_duration").value = "0";
            document.getElementById("start_call").textContent = "ÿ¥ÿ±Ÿàÿπ ÿ™ŸÖÿßÿ≥ (0s)";
            document.getElementById("start_call").classList.remove("btn-danger", "btn-secondary");
            document.getElementById("start_call").classList.add("btn-success");

            // Ÿæÿß⁄© ⁄©ÿ±ÿØŸÜ ŸÖÿ™ŸÜ ÿ¥ÿ±ÿ≠ ÿ™ŸÖÿßÿ≥
            document.getElementById("id_call_description").value = "";
        });
    </script>



    <script>
        // ÿØÿßÿØŸá‚ÄåŸáÿß€å Ÿæÿßÿ≥‚ÄåÿØÿßÿØŸá ÿ¥ÿØŸá ÿßÿ≤ Django
        const chartLabels = {{ chart_labels|safe }}; // ŸÑ€åÿ≥ÿ™ ÿ®ÿ±⁄Üÿ≥ÿ®‚ÄåŸáÿß€å ÿ™ÿßÿ±€åÿÆ
        const chartDataSets = {{ chart_date|safe }}; // ÿØÿßÿØŸá‚ÄåŸáÿß€å Ÿáÿ± ÿ≥ÿßŸÑÿå ŸÑ€åÿ≥ÿ™ ŸÑ€åÿ≥ÿ™‚ÄåŸáÿß
        const yearList = {{ year_list|safe }}; // ŸÑ€åÿ≥ÿ™ ÿ≥ÿßŸÑ‚ÄåŸáÿß

        // ÿ±ŸÜ⁄Ø‚ÄåŸáÿß€å Ÿæ€åÿ¥ŸÜŸáÿßÿØ€å ÿ®ÿ±ÿß€å Ÿáÿ± ÿ≥ÿßŸÑ - ÿß⁄Øÿ± ÿ™ÿπÿØÿßÿØ ÿ≥ÿßŸÑ‚ÄåŸáÿß ÿ®€åÿ¥ÿ™ÿ± ÿ¥ÿØÿå ÿ®ÿß€åÿØ ÿ±ŸÜ⁄Ø‚ÄåŸáÿß€å ÿ®€åÿ¥ÿ™ÿ±€å ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ
        const colors = [
            'red', 'blue', 'green', 'teal', 'orange', 'purple', 'brown', 'cyan', 'magenta', 'lime'
        ];
        const datasets = chartDataSets.map((data, index) => {
            const isFirstLine = index === 0; // ÿßŸàŸÑ€å
            return {
                label: `${yearList[index]}`, // ŸÅŸÇÿ∑ ÿ≥ÿßŸÑ ÿ®ÿØŸàŸÜ ⁄©ŸÑŸÖŸá 'ÿ≥ÿßŸÑ'
                data: data,
                borderColor: colors[index % colors.length],
                fill: isFirstLine ? true : false, // ÿØÿ± ÿµŸàÿ±ÿ™ ŸÜ€åÿßÿ≤
                fillColor: 'rgba(158,19,19,0.1)',
                pointRadius: 0,
                borderDash: isFirstLine ? [5, 5] : [], // ÿÆÿ∑ ⁄Ü€åŸÜ ÿ®ÿ±ÿß€å ÿßŸàŸÑ€åŸÜ ÿÆÿ∑
            };
        });

        // ÿ±ÿ≥ŸÖ ŸÜŸÖŸàÿØÿßÿ±
        const ctx = document.getElementById('Chart1').getContext('2d');

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartLabels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        title: {display: true, text: "ÿ™ÿßÿ±€åÿÆ"}
                    },
                    y: {
                        title: {display: true, text: "ŸÖŸÇÿØÿßÿ± ÿ™ÿ¨ŸÖÿπ€å"}
                    }
                },
                plugins: {
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function (context) {
                                // ÿ™ŸÇÿ≥€åŸÖ ÿ®ÿ± 10 ŸÖ€åŸÑ€åŸàŸÜÿå ÿ®ÿß €å⁄© ÿ±ŸÇŸÖ ÿßÿπÿ¥ÿßÿ±
                                var value = context.parsed.y / 10000000;
                                return context.dataset.label + ': ' + value.toFixed(1) + ' ŸÖ€åŸÑ€åŸàŸÜ ÿ™ŸàŸÖÿßŸÜ';
                            },
                            title: function (tooltipItems) {
                                return 'ÿ™ÿßÿ±€åÿÆ: ' + tooltipItems[0].label;
                            }
                        }
                    },
                    legend: {
                        display: true,
                        position: 'top'
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });
    </script>



{% endblock %}


{% block date %}
    <script src="{% static 'js/table1/tableExport.min.js' %}"></script>
    <script src="{% static 'js/table1/bootstrap-table.min.js' %}"></script>
    <script src="{% static 'js/table1/bootstrap-table-locale-all.min.js' %}"></script>
    <script src="{% static 'js/table1/bootstrap-table-export.min.js' %}"></script>
    <script src="{% static 'js/table1/natural-sorting.js' %}"></script>
    <script src="{% static 'js/table1/bootstrap-table-filter-control.min.js' %}"></script>
    <script src="{% static 'js/table1/bootstrap-table-print.min.js' %}"></script>
    <script src="{% static 'js/table1/jspdf.min.js' %}"></script>
    <script src="{% static 'js/table1/jspdf.plugin.autotable.js' %}"></script>

    <script>
        var $table = $('#table');
        var totalMandah = 0; // ŸÖÿ™ÿ∫€åÿ± ÿ®ÿ±ÿß€å ÿ∞ÿÆ€åÿ±Ÿá ŸÖÿ¨ŸÖŸàÿπ ŸÖÿßŸÜÿØŸá

        $(function () {
            $table.bootstrapTable();
            updateTotalMandah(); // ÿ®Ÿá‚Äåÿ±Ÿàÿ≤ÿ±ÿ≥ÿßŸÜ€å ŸÜŸÖÿß€åÿ¥ ŸÖÿ¨ŸÖŸàÿπ ŸÖÿßŸÜÿØŸá ŸáŸÜ⁄ØÿßŸÖ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ÿ¨ÿØŸàŸÑ
        });

        function priceFormatter(data) {
            var field = this.field;
            {#console.log("Data received for priceFormatter:", data);#}
            var result = data.map(function (row) {
                var valueString = row[field].replace(/,/g, ''); // ÿ≠ÿ∞ŸÅ ⁄©ÿßŸÖÿßŸáÿß
                var value = parseFloat(valueString);
                {#console.log("Processing row:", row);#}
                {#console.log("Parsed value:", value);#}
                return isNaN(value) ? 0 : value;
            }).reduce(function (sum, i) {
                {#console.log("Current sum:", sum);#}
                return sum + i;
            }, 0);
            {#console.log("Final result for priceFormatter:", result);#}
            totalMandah = result; // ÿ∞ÿÆ€åÿ±Ÿá ŸÖÿ¨ŸÖŸàÿπ ŸÖÿßŸÜÿØŸá
            updateTotalMandah(); // ÿ®Ÿá‚Äåÿ±Ÿàÿ≤ÿ±ÿ≥ÿßŸÜ€å ŸÜŸÖÿß€åÿ¥ ŸÖÿ¨ŸÖŸàÿπ ŸÖÿßŸÜÿØŸá
            return result.toLocaleString('fa-IR'); // ŸÜŸÖÿß€åÿ¥ ÿ®ÿß ⁄©ÿßŸÖÿß ÿ®Ÿá ÿµŸàÿ±ÿ™ 3 ÿ™ÿß 3 ÿ™ÿß
        }

        function updateTotalMandah() {
            $('#total-mandah').text(totalMandah.toLocaleString('fa-IR'));
        }
    </script>




{% endblock %}




