{% extends 'shared/_MainLayout.html' %}
{% load humanize %}
{% load static %}
{% block content %}
    {% load jalali_tags %}
    {% load custom_filters %}

    <div class="content-wrapper">

        <div class="page-title">


            <!-- Ø±Ø¯ÛŒÙ Ø¬Ø²Ø¦ÛŒØ§Øª Ø§Ø³Ù†Ø§Ø¯ -->
            <div class="row">
                <div class="col-md-12 mb-30">
                    <div class="col-xl-12 mb-30">
                        <div class="card card-statistics h-100">
                            <div class="card-body">
                                <div class="table-responsive mt-15 ">
                                    <h6 class="card-title pb-0 border-0">Ù…Ø§Ù†Ø¯Ù‡
{#                                        Ø­Ø³Ø§Ø¨ {{ hesabmoshtari.person.name }} {{ hesabmoshtari.person.lname }} :</h6>#}
                                    <h5 class="card-title pb-0 border-0"><span id="total-mandah"
                                                                               class="text-primary"></span>
                                        Ø±ÛŒØ§Ù„ </h5>
                                    <div class="table-responsive">
                                        <table id="table"
                                               class="table-striped"
                                               data-toggle="table"
                                               data-locale="fa-IR"
                                               data-search="true"
                                               data-show-columns="true"
                                               data-show-export="true"
                                               data-show-refresh="true"
                                               data-show-columns-toggle-all="true"
                                               data-show-pagination-switch="true"
                                               data-show-toggle="true"
                                               data-show-fullscreen="true"
                                               data-buttons="buttons"
                                               data-search-align="left"
                                               data-buttons-class="primary"
                                               data-pagination="true"
                                               data-show-columns-search="true"
                                               data-show-footer="true"
                                               data-page-size="10"
                                               data-remember-order="true"
                                               data-sortable="true"
                                               data-show-search-clear-button="true"
                                                {#                                                   data-sort-name="date"#}
                                               data-sort-order="asc"
                                               data-filter-control="true"
                                               data-show-print="true"
                                               data-export-data-type="all"
                                               data-export-types='["excel"]'>
                                            <thead>
                                            <tr class="tr-class-1">
                                                <th class="card-text text-center" data-sortable="true"
                                                    data-field="code"
                                                    data-filter-control="input">Ú©Ø¯
                                                </th>
                                                <th class="card-text text-center" data-sortable="true"
                                                    data-field="radif"
                                                    data-filter-control="input">Ø±Ø¯ÛŒÙ
                                                </th>
                                                <th class="card-text text-center" data-sortable="true"
                                                    data-field="date"
                                                    data-filter-control="select">ØªØ§Ø±ÛŒØ®
                                                </th>
                                                <th class="card-text text-center" data-sortable="true"
                                                    data-field="kind" data-filter-control="select">Ù†ÙˆØ¹
                                                </th>
                                                <th class="card-text text-center" data-sortable="true"
                                                    data-field="sharh"
                                                    data-filter-control="input">Ø´Ø±Ø­ Ø³Ù†Ø¯
                                                </th>
                                                <th class="card-text text-center" data-sortable="true"
                                                    data-field="bed" data-footer-formatter="priceFormatter">Ø¨Ø¯Ù‡Ú©Ø§Ø±
                                                </th>
                                                <th class="card-text text-center" data-sortable="true"
                                                    data-field="bes" data-footer-formatter="priceFormatter">Ø¨Ø³ØªØ§Ù†Ú©Ø§Ø±
                                                </th>
                                                <th class="card-text text-center" data-sortable="true"
                                                    data-field="mand1" data-footer-formatter="priceFormatter">Ù…Ø§Ù†Ø¯Ù‡ Ø³Ù†Ø¯
                                                </th>
                                                {#                                                <th class="card-text text-center" data-sortable="true"#}
                                                {#                                                    data-field="mandkol"#}
                                                {#                                                    data-filter-control="select">Ù…Ø§Ù†Ø¯Ù‡ Ú©Ù„#}
                                                {#                                                </th>#}

                                            </tr>
                                            </thead>
                                            <tbody>
                                            {% for s in asnadp %}
                                                <tr>
                                                    <td class="card-text text-center">{{ s.person }}</td>
                                                    <td class="card-text text-center">{{ s.radif }}</td>
                                                    <td class="card-text text-center">{{ s.tarikh }}</td>
                                                    {#                                                    <td class="card-text text-center ">{{ s.kind.0 }}</td>#}
                                                    <td class="card-text text-center text-{{ s.kind.2 }}">{{ s.kind.1 }}</td>
                                                    {#                                                     <td class="card-text text-center ">{{ s.syscomment }}</td>#}
                                                    <td class="card-text text-center ">
                                                        {% if s.syscomment %}
                                                            {{ s.syscomment }}
                                                        {% else %}
                                                            {{ s.sharh }}
                                                        {% endif %}
                                                    </td>

                                                    <td class="card-text text-center">{{ s.bed|floatformat:0|intcomma:False }}</td>
                                                    <td class="card-text text-center">{{ s.bes|floatformat:0|intcomma:False }}</td>
                                                    <td class="card-text text-center"
                                                        style="direction: ltr">{{ s.curramount|floatformat:0|intcomma:False }}</td>
                                                    {#                                                    <td class="card-text text-center"></td>#}
                                                </tr>
                                            {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>


                            </div>
                        </div>
                    </div>
                </div>
            </div>


        </div>


    </div>


{% endblock %}





{% block myjs %}
    <script>
        document.getElementById("start_call").addEventListener("click", function () {
            let button = this;

            if (button.classList.contains("btn-success")) {
                button.textContent = "Ù¾Ø§ÛŒØ§Ù† ØªÙ…Ø§Ø³ (0s)";
                button.classList.remove("btn-success");
                button.classList.add("btn-danger");

                let counter = 0;
                let timer = setInterval(() => {
                    counter++;
                    document.getElementById("call_duration").value = counter;
                    button.textContent = `Ù¾Ø§ÛŒØ§Ù† ØªÙ…Ø§Ø³ (${counter}s)`; // ğŸ”¹ Ù†Ù…Ø§ÛŒØ´ Ø«Ø§Ù†ÛŒÙ‡ Ø¯Ø§Ø®Ù„ Ø¯Ú©Ù…Ù‡
                }, 1000);

                button.setAttribute("data-timer", timer);

                let phoneNumber = document.getElementById("id_phone_number").value;
                window.location.href = `tel:${phoneNumber}`;

            } else {
                clearInterval(button.getAttribute("data-timer"));
                button.classList.remove("btn-danger");
                button.classList.add("btn-secondary");
                button.textContent = `ØªÙ…Ø§Ø³ Ù¾Ø§ÛŒØ§Ù† ÛŒØ§ÙØª (${document.getElementById("call_duration").value}s)`;
            }
        });

        // ğŸ›  Ø¯Ú©Ù…Ù‡ Ø§Ù†ØµØ±Ø§Ù -> ØªÙ†Ø¸ÛŒÙ… Ø²Ù…Ø§Ù† ØªÙ…Ø§Ø³ Ø¨Ù‡ ØµÙØ± Ùˆ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø´Ø±Ø­ ØªÙ…Ø§Ø³
        document.getElementById("cancel_call").addEventListener("click", function () {
            clearInterval(document.getElementById("start_call").getAttribute("data-timer"));
            document.getElementById("call_duration").value = "0";
            document.getElementById("start_call").textContent = "Ø´Ø±ÙˆØ¹ ØªÙ…Ø§Ø³ (0s)";
            document.getElementById("start_call").classList.remove("btn-danger", "btn-secondary");
            document.getElementById("start_call").classList.add("btn-success");

            // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù…ØªÙ† Ø´Ø±Ø­ ØªÙ…Ø§Ø³
            document.getElementById("id_call_description").value = "";
        });
    </script>



{% endblock %}


{% block date %}
    <script src="{% static 'js/table1/tableExport.min.js' %}"></script>
    <script src="{% static 'js/table1/bootstrap-table.min.js' %}"></script>
    <script src="{% static 'js/table1/bootstrap-table-locale-all.min.js' %}"></script>
    <script src="{% static 'js/table1/bootstrap-table-export.min.js' %}"></script>
    <script src="{% static 'js/table1/natural-sorting.js' %}"></script>
    <script src="{% static 'js/table1/bootstrap-table-filter-control.min.js' %}"></script>
    <script src="{% static 'js/table1/bootstrap-table-print.min.js' %}"></script>
    <script src="{% static 'js/table1/jspdf.min.js' %}"></script>
    <script src="{% static 'js/table1/jspdf.plugin.autotable.js' %}"></script>

    <script>
        var $table = $('#table');
        var totalMandah = 0; // Ù…ØªØºÛŒØ± Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ù…Ø¬Ù…ÙˆØ¹ Ù…Ø§Ù†Ø¯Ù‡

        $(function () {
            $table.bootstrapTable();
            updateTotalMandah(); // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù…Ø¬Ù…ÙˆØ¹ Ù…Ø§Ù†Ø¯Ù‡ Ù‡Ù†Ú¯Ø§Ù… Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¬Ø¯ÙˆÙ„
        });

        function priceFormatter(data) {
            var field = this.field;
            {#console.log("Data received for priceFormatter:", data);#}
            var result = data.map(function (row) {
                var valueString = row[field].replace(/,/g, ''); // Ø­Ø°Ù Ú©Ø§Ù…Ø§Ù‡Ø§
                var value = parseFloat(valueString);
                {#console.log("Processing row:", row);#}
                {#console.log("Parsed value:", value);#}
                return isNaN(value) ? 0 : value;
            }).reduce(function (sum, i) {
                {#console.log("Current sum:", sum);#}
                return sum + i;
            }, 0);
            {#console.log("Final result for priceFormatter:", result);#}
            totalMandah = result; // Ø°Ø®ÛŒØ±Ù‡ Ù…Ø¬Ù…ÙˆØ¹ Ù…Ø§Ù†Ø¯Ù‡
            updateTotalMandah(); // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù…Ø¬Ù…ÙˆØ¹ Ù…Ø§Ù†Ø¯Ù‡
            return result.toLocaleString('fa-IR'); // Ù†Ù…Ø§ÛŒØ´ Ø¨Ø§ Ú©Ø§Ù…Ø§ Ø¨Ù‡ ØµÙˆØ±Øª 3 ØªØ§ 3 ØªØ§
        }

        function updateTotalMandah() {
            $('#total-mandah').text(totalMandah.toLocaleString('fa-IR'));
        }
    </script>




{% endblock %}




