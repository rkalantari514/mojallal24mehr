{% extends 'events/base_events.html' %}

{% block events_content %}
<h2 class="mb-4">{% if event_detail %}ویرایش جزئیات برگزاری{% else %}افزودن جزئیات برگزاری جدید{% endif %}</h2>

<form method="post" enctype="multipart/form-data"> {# enctype برای آپلود فایل لازم است #}
    {% csrf_token %}

    {# EventDetail Form #}
    <div class="card mb-4">
        <div class="card-header">اطلاعات اصلی جزئیات برگزاری</div>
        <div class="card-body">
            {% for field in form %}
                <div class="mb-3">
                    <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                    {{ field }}
                    {% if field.help_text %}
                        <div class="form-text">{{ field.help_text }}</div>
                    {% endif %}
                    {% for error in field.errors %}
                        <div class="invalid-feedback d-block">{{ error }}</div>
                    {% endfor %}
                </div>
            {% endfor %}
            {% if form.non_field_errors %}
                <div class="alert alert-danger">
                    {% for error in form.non_field_errors %}
                        <p>{{ error }}</p>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
    </div>

    {# Resolution Formset #}
    <div class="card mb-4">
        <div class="card-header">مصوبات</div>
        <div class="card-body">
            {{ resolutions.management_form }}
            <div id="resolutions-formset-container">
                {% for res_form in resolutions %}
                    <div class="formset-row border p-3 mb-3 rounded">
                        {% for hidden_field in res_form.hidden_fields %}
                            {{ hidden_field }}
                        {% endfor %}
                        {% for field in res_form.visible_fields %}
                            <div class="mb-3">
                                <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                                {{ field }}
                                {% for error in field.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            </div>
                        {% endfor %}
                        {% if resolutions.can_delete %}
                            <div class="form-check mb-3">
                                {{ res_form.DELETE }}
                                <label class="form-check-label" for="{{ res_form.DELETE.id_for_label }}">حذف این مصوبه</label>
                            </div>
                        {% endif %}
                        {% if res_form.non_field_errors %}
                            <div class="alert alert-danger">
                                {% for error in res_form.non_field_errors %}
                                    <p>{{ error }}</p>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
            <button type="button" class="btn btn-secondary btn-sm" onclick="addForm('resolutions', document.getElementById('empty-resolution-form').innerHTML)">افزودن مصوبه</button>
        </div>
    </div>

    {# EventImage Formset #}
    <div class="card mb-4">
        <div class="card-header">تصاویر</div>
        <div class="card-body">
            {{ images.management_form }}
            <div id="images-formset-container">
                {% for img_form in images %}
                    <div class="formset-row border p-3 mb-3 rounded">
                        {% for hidden_field in img_form.hidden_fields %}
                            {{ hidden_field }}
                        {% endfor %}
                        {% for field in img_form.visible_fields %}
                            <div class="mb-3">
                                <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                                {{ field }}
                                {% for error in field.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            </div>
                        {% endfor %}
                        {% if images.can_delete %}
                            <div class="form-check mb-3">
                                {{ img_form.DELETE }}
                                <label class="form-check-label" for="{{ img_form.DELETE.id_for_label }}">حذف این تصویر</label>
                            </div>
                        {% endif %}
                        {% if img_form.non_field_errors %}
                            <div class="alert alert-danger">
                                {% for error in img_form.non_field_errors %}
                                    <p>{{ error }}</p>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
            <button type="button" class="btn btn-secondary btn-sm" onclick="addForm('images', document.getElementById('empty-image-form').innerHTML)">افزودن تصویر</button>
        </div>
    </div>

    <button type="submit" class="btn btn-success mt-3">ذخیره</button>
    <a href="{% if event_detail %}{% url 'events:event_detail' event_detail.event.pk %}{% else %}{% url 'events:event_list' %}{% endif %}" class="btn btn-secondary mt-3">بازگشت</a>
</form>

{# Hidden templates for adding new formset forms via JavaScript #}
<div id="empty-resolution-form" style="display: none;">
    <div class="formset-row border p-3 mb-3 rounded">
        {% for hidden_field in resolutions.empty_form.hidden_fields %}
            {{ hidden_field }}
        {% endfor %}
        {% for field in resolutions.empty_form.visible_fields %}
            <div class="mb-3">
                <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                {{ field }}
            </div>
        {% endfor %}
        <div class="form-check mb-3">
            {{ resolutions.empty_form.DELETE }}
            <label class="form-check-label" for="{{ resolutions.empty_form.DELETE.id_for_label }}">حذف این مصوبه</label>
        </div>
        <button type="button" class="btn btn-sm btn-danger" onclick="deleteForm('resolutions', this)">حذف</button>
    </div>
</div>

<div id="empty-image-form" style="display: none;">
    <div class="formset-row border p-3 mb-3 rounded">
        {% for hidden_field in images.empty_form.hidden_fields %}
            {{ hidden_field }}
        {% endfor %}
        {% for field in images.empty_form.visible_fields %}
            <div class="mb-3">
                <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                {{ field }}
            </div>
        {% endfor %}
        <div class="form-check mb-3">
            {{ images.empty_form.DELETE }}
            <label class="form-check-label" for="{{ images.empty_form.DELETE.id_for_label }}">حذف این تصویر</label>
        </div>
        <button type="button" class="btn btn-sm btn-danger" onclick="deleteForm('images', this)">حذف</button>
    </div>
</div>

{% endblock %}