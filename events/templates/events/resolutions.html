{% extends 'events/base_events.html' %}
{% load jalali_tags %}

{% block events_content %}
    <div class="container mt-4">
        <h2>ğŸ“‹ Ù…ØµÙˆØ¨Ø§Øª Ùˆ ÙˆØ¸Ø§ÛŒÙ</h2>
        <p class="text-muted">Ù…Ø¯ÛŒØ±ÛŒØª Ùˆ ÙÛŒÙ„ØªØ± Ú©Ø±Ø¯Ù† Ù…ØµÙˆØ¨Ø§Øª Ø¨Ø± Ø§Ø³Ø§Ø³ ÙˆØ¶Ø¹ÛŒØªØŒ Ù…Ù‡Ù„Øª Ùˆ Ù…Ø³Ø¦ÙˆÙ„.</p>

        <!-- ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ Ø¯ÛŒÙ†Ø§Ù…ÛŒÚ© JS -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0">ğŸ” ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">

                    <!-- ÙÛŒÙ„ØªØ± ÙˆØ¶Ø¹ÛŒØª -->
                    <div class="col-md-3">
                        <label for="status-filter" class="form-label">ÙˆØ¶Ø¹ÛŒØª:</label>
                        <select id="status-filter" class="form-select">
                            <option value="">Ù‡Ù…Ù‡</option>
                            {% for code, name in status_choices %}
                                <option value="{{ code }}"
                                        {% if selected_status == code %}selected{% endif %}>{{ name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- ÙÛŒÙ„ØªØ± Ù…Ù‡Ù„Øª -->
                    <div class="col-md-3">
                        <label for="date-filter" class="form-label">Ù…Ù‡Ù„Øª:</label>
                        <select id="date-filter" class="form-select">
                            <option value="">Ù‡Ù…Ù‡</option>
                            <option value="today" {% if selected_date_filter == 'today' %}selected{% endif %}>Ø§Ù…Ø±ÙˆØ²
                            </option>
                            <option value="tomorrow" {% if selected_date_filter == 'tomorrow' %}selected{% endif %}>
                                ÙØ±Ø¯Ø§
                            </option>
                            <option value="next_week" {% if selected_date_filter == 'next_week' %}selected{% endif %}>
                                Ù‡ÙØªÙ‡ Ø¢ÛŒÙ†Ø¯Ù‡
                            </option>
                            <option value="overdue" {% if selected_date_filter == 'overdue' %}selected{% endif %}>ØªØ£Ø®ÛŒØ±
                                Ø¯Ø§Ø±
                            </option>
                        </select>
                    </div>

                    <!-- ÙÛŒÙ„ØªØ± ÙˆØ¸Ø§ÛŒÙ Ù…Ù† -->
                    <div class="col-md-2">
                        <label for="assigned-to-me" class="form-label">ÙˆØ¸Ø§ÛŒÙ Ù…Ù†:</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="assigned-to-me"
                                   {% if assigned_to_me == 'true' %}checked{% endif %}>
                            <label class="form-check-label" for="assigned-to-me">ÙÙ‚Ø· Ù…Ù†</label>
                        </div>
                    </div>

                    <!-- ÙÛŒÙ„ØªØ± ÙˆØ¸Ø§ÛŒÙ Ø¯ÛŒÚ¯Ø±Ø§Ù† -->
                    <div class="col-md-2">
                        <label for="assigned-to-others" class="form-label">ÙˆØ¸Ø§ÛŒÙ Ø¯ÛŒÚ¯Ø±Ø§Ù†:</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="assigned-to-others"
                                   {% if assigned_to_others == 'true' %}checked{% endif %}>
                            <label class="form-check-label" for="assigned-to-others">ØºÛŒØ± Ù…Ù†</label>
                        </div>
                    </div>

                    <!-- Ø¯Ú©Ù…Ù‡ Ø±ÛŒØ³Øª -->
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="button" id="reset-filters" class="btn btn-outline-secondary w-100">Ø­Ø°Ù ÙÛŒÙ„ØªØ±Ù‡Ø§</button>
                    </div>

                </div>
            </div>
        </div>

        <!-- Ø¬Ø¯ÙˆÙ„ Ù…ØµÙˆØ¨Ø§Øª -->
        <div class="row">
            <div class="col-xl-12 mb-30">
                <div class="card card-statistics h-100">
                    <div class="card-body">

                        <div class="table-responsive">
                            <table class="table  table-hover center-aligned-table mb-10 text-center"
                                   id="resolutions-table">
                                <thead>
                                <tr class="text-dark">
                                    <th>Ù…ØªÙ† Ù…ØµÙˆØ¨Ù‡</th>
                                    <th>Ø±ÙˆÛŒØ¯Ø§Ø¯</th>
                                    <th>Ù…Ù‡Ù„Øª</th>
                                    <th>Ù…Ø³Ø¦ÙˆÙ„</th>
                                    <th>ÙˆØ¶Ø¹ÛŒØª</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for resolution in resolutions %}
                                    <tr data-status="{{ resolution.status }}"
                                        data-due-date="{{ resolution.due_date|default:'' }}"
                                        data-responsible="{{ resolution.responsible_person.id|default:'' }}"
                                        data-responsible-name="
                                                {{ resolution.responsible_person.get_full_name|default:'Ø¨Ø¯ÙˆÙ† Ù…Ø³Ø¦ÙˆÙ„' }}">
                                        <td>
                                            {{ resolution.text|truncatechars:80 }}
                                            {% if resolution.due_date and resolution.due_date < today and resolution.status == 'pending' %}
                                                <span class="btn btn-danger mx-1">ØªØ§Ø®ÛŒØ±</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <a href="{% url 'events:event_detail' resolution.event_detail.event.pk %}">
                                                {{ resolution.event_detail.event.name }}
                                            </a>
                                            <br>
                                            <small class="text-muted">
                                                {{ resolution.event_detail.scheduled_date|to_jalali:'%Y/%m/%d' }}
                                            </small>
                                        </td>
                                        <td>
                                            {% if resolution.due_date %}
                                                {{ resolution.due_date|to_jalali:'%Y/%m/%d' }}
                                            {% else %}
                                                <span class="text-muted">â€”</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if resolution.responsible_person %}
                                                {{ resolution.responsible_person.get_full_name }}
                                                <img class="img-fluid avatar-small"
                                                     src="{{ resolution.responsible_person.avatar.url }}" alt="">
                                            {% else %}
                                                <span class="text-muted">â€”</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if resolution.status == 'pending' %}
                                                <span class="btn btn-warning">Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯Ù‡</span>
                                            {% elif resolution.status == 'completed' %}
                                                <span class="btn btn-success">Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡</span>
                                            {% elif resolution.status == 'cancelled' %}
                                                <span class="btn btn-secondary">Ù…Ù†ØªÙÛŒ</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">Ù‡ÛŒÚ† Ù…ØµÙˆØ¨Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>

                            <!-- Pagination -->
                            {% if is_paginated %}
                                <nav aria-label="Page navigation">
                                    <ul class="pagination">
                                        {% if page_obj.has_previous %}
                                            <li class="page-item"><a class="page-link" href="?page=

                                                    {{ page_obj.previous_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Ù‚Ø¨Ù„ÛŒ</a>
                                            </li>
                                        {% endif %}
                                        <li class="page-item active"><span
                                                class="page-link">{{ page_obj.number }} Ø§Ø² {{ page_obj.paginator.num_pages }}</span>
                                        </li>
                                        {% if page_obj.has_next %}
                                            <li class="page-item"><a class="page-link" href="?page=

                                                    {{ page_obj.next_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Ø¨Ø¹Ø¯ÛŒ</a>
                                            </li>
                                        {% endif %}
                                    </ul>
                                </nav>
                            {% endif %}

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JS ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ Ø¯ÛŒÙ†Ø§Ù…ÛŒÚ© -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const table = document.getElementById('resolutions-table');
            const rows = Array.from(table.querySelectorAll('tbody tr'));

            // ØªØ§Ø¨Ø¹ ÙÛŒÙ„ØªØ± Ú©Ø±Ø¯Ù†
            function applyFilters() {
                const statusFilter = document.getElementById('status-filter').value;
                const dateFilter = document.getElementById('date-filter').value;
                const assignedToMe = document.getElementById('assigned-to-me').checked;
                const assignedToOthers = document.getElementById('assigned-to-others').checked;

                const today = new Date();
                const tomorrow = new Date(today.getTime() + 24 * 60 * 60 * 1000);
                const nextWeek = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);

                rows.forEach(row => {
                    const status = row.dataset.status;
                    const dueDateStr = row.dataset.dueDate;
                    const responsibleId = row.dataset.responsible;
                    const responsibleName = row.dataset.responsibleName;

                    let showRow = true;

                    // ÙÛŒÙ„ØªØ± ÙˆØ¶Ø¹ÛŒØª
                    if (statusFilter && status !== statusFilter) {
                        showRow = false;
                    }

                    // ÙÛŒÙ„ØªØ± Ù…Ù‡Ù„Øª
                    if (dueDateStr) {
                        const dueDate = new Date(dueDateStr);
                        if (dateFilter === 'today' && dueDate.toDateString() !== today.toDateString()) {
                            showRow = false;
                        } else if (dateFilter === 'tomorrow' && dueDate.toDateString() !== tomorrow.toDateString()) {
                            showRow = false;
                        } else if (dateFilter === 'next_week' && (dueDate < today || dueDate > nextWeek)) {
                            showRow = false;
                        } else if (dateFilter === 'overdue' && (dueDate >= today || status !== 'pending')) {
                            showRow = false;
                        }
                    } else if (dateFilter === 'today' || dateFilter === 'tomorrow' || dateFilter === 'next_week' || dateFilter === 'overdue') {
                        showRow = false; // Ø§Ú¯Ø± Ù…Ù‡Ù„Øª Ù†Ø¯Ø§Ø±Ø¯ Ùˆ ÙÛŒÙ„ØªØ± Ù…Ù‡Ù„Øª ÙØ¹Ø§Ù„ Ø§Ø³ØªØŒ Ù†Ù…Ø§ÛŒØ´ Ù†Ø¯Ù‡
                    }

                    // ÙÛŒÙ„ØªØ± ÙˆØ¸Ø§ÛŒÙ Ù…Ù†
                    if (assignedToMe && responsibleId !== '{{ request.user.id }}') {
                        showRow = false;
                    }

                    // ÙÛŒÙ„ØªØ± ÙˆØ¸Ø§ÛŒÙ Ø¯ÛŒÚ¯Ø±Ø§Ù†
                    if (assignedToOthers && (responsibleId === '{{ request.user.id }}' || !responsibleId)) {
                        showRow = false;
                    }

                    row.style.display = showRow ? '' : 'none';
                });

                // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù¾ÛŒØºØ§Ù… Ø®Ø§Ù„ÛŒ
                const emptyMessage = table.querySelector('tbody tr td[colspan="5"]');
                if (emptyMessage) {
                    emptyMessage.closest('tr').style.display = Array.from(rows).some(r => r.style.display !== 'none') ? 'none' : '';
                }
            }

            // Ø§ØªØµØ§Ù„ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§
            document.getElementById('status-filter').addEventListener('change', applyFilters);
            document.getElementById('date-filter').addEventListener('change', applyFilters);
            document.getElementById('assigned-to-me').addEventListener('change', applyFilters);
            document.getElementById('assigned-to-others').addEventListener('change', applyFilters);

            // Ø±ÛŒØ³Øª ÙÛŒÙ„ØªØ±Ù‡Ø§
            document.getElementById('reset-filters').addEventListener('click', function () {
                document.getElementById('status-filter').value = '';
                document.getElementById('date-filter').value = '';
                document.getElementById('assigned-to-me').checked = false;
                document.getElementById('assigned-to-others').checked = false;
                applyFilters();

                // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ URL Ø¨Ø¯ÙˆÙ† Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ ÙÛŒÙ„ØªØ±
                const url = new URL(window.location);
                url.search = ''; // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØªÙ…Ø§Ù… Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§
                window.history.pushState({}, '', url);
            });

            // Ø§ÙˆÙ„ÛŒÙ† Ø¨Ø§Ø± ÙÛŒÙ„ØªØ± Ú©Ù†
            applyFilters();
        });
    </script>

{% endblock %}