{% extends 'shared/_MainLayout.html' %}
{% load static %}
{% load humanize %}
{% block content %}
    <style>
        .btn-fixed-width {
            width: 120px;
            text-align: right;
        }
    </style>
    <div class="content-wrapper">
        <div class="page-title">
            <div class="row">
                <div class="col-sm-6">
                    <div class="d-block">
                        <h4 class="card-title text-facebook pb-0 border-0">لیست فاکتورهای برگشتی
                            سال {{ year }} - {{ detail_name }}</h4>
                    </div>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb pt-0 pr-0 float-left float-sm-right">
                        <li class="breadcrumb-item"><a href="/" class="default-color"> خانه</a></li>
                        <li class="breadcrumb-item active">لیست فاکتورهای برگشتی سال {{ year }}</li>
                    </ol>
                </div>
            </div>

            <div class="row">
                <div class="col-md-12 mb-30">
                    <div class="col-xl-12 mb-30">
                        <div class="card card-statistics h-100">
                            <div class="card-body">
                                <div class="table-responsive mt-15 ">
                                    <h5 class="card-title pb-0 border-0">لیست فاکتورهای برگشتی</h5>
                                    <h6 class="card-title pb-0 border-0">فاکتورهای برگشتی سال {{ year }} <span
                                            id="total-mandah"
                                            class="text-primary"></span>
                                        عدد </h6>
                                    <div class="table-responsive">
                                        <table id="table"
                                               class="table-striped"
                                               data-toggle="table"
                                               data-locale="fa-IR"
                                               data-search="true"
                                               data-show-columns="true"
                                               data-show-export="true"
                                               data-show-refresh="true"
                                               data-show-columns-toggle-all="true"
                                               data-show-pagination-switch="true"
                                               data-show-toggle="true"
                                               data-show-fullscreen="true"
                                               data-buttons="buttons"
                                               data-search-align="left"
                                               data-buttons-class="primary"
                                               data-pagination="true"
                                               data-show-columns-search="true"
                                               data-show-footer="true"
                                               data-page-size="100"
                                               data-remember-order="true"
                                               data-sortable="true"
                                               data-show-search-clear-button="true"
                                               data-sort-name="count"
                                               data-sort-order="desc"
                                               data-filter-control="true"
                                               data-show-print="true"
                                               data-export-data-type="all"
                                               data-export-types='["excel"]'>
                                            <thead>
                                            <tr class="tr-class-1">
                                                <th data-field="code_factor" class="card-text text-center"
                                                    data-sortable="true" data-filter-control="select">کد فاکتور
                                                </th>
                                                <th data-field="radif" class="card-text text-center"
                                                    data-sortable="true">ردیف
                                                </th>
                                                <th data-field="tarikh" class="card-text text-center"
                                                    data-sortable="true" data-filter-control="select">تاریخ
                                                </th>
                                                <th data-field="month" class="card-text text-center"
                                                    data-sortable="true" data-filter-control="select">ماه
                                                </th>
                                                <th data-field="l1" class="card-text text-center"
                                                    data-sortable="true" data-filter-control="select">سطح 1
                                                </th>
                                                <th data-field="l2" class="card-text text-center"
                                                    data-sortable="true" data-filter-control="select">سطح 2
                                                </th>
                                                <th data-field="l3" class="card-text text-center"
                                                    data-sortable="true" data-filter-control="select">سطح 3
                                                </th>
                                                <th data-field="code_kala" class="card-text text-center"
                                                    data-sortable="true">کد کالا
                                                </th>
                                                <th data-field="name_kala" class="card-text text-center"
                                                    data-sortable="true">نام کالا
                                                </th>
                                                <th data-field="count" class="card-text text-center"
                                                    data-sortable="true" data-sorter="numericOnly"
                                                    data-footer-formatter="priceFormatter">تعداد برگشتی
                                                </th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                            {% for item in back_factors %}
                                                <tr>
                                                    <td class="card-text text-center">{{ item.code_factor }}</td>
                                                    <td class="card-text text-center">{{ item.radif }}</td>
                                                    <td class="card-text text-center">{{ item.backfactor.pdate }}</td>
                                                    <td class="card-text text-center">{{ item.backfactor.pdate|slice:"5:7" }}</td>
                                                    <td class="card-text text-center">{{ item.kala.category.parent.parent.name }}</td>
                                                    <td class="card-text text-center">{{ item.kala.category.parent.name }}</td>
                                                    <td class="card-text text-center">{{ item.kala.category.name }}</td>
                                                    <td class="card-text text-center">{{ item.code_kala }}</td>
                                                    <td class="card-text text-center">{{ item.kala.name }}</td>
                                                    <td class="card-text text-center">{{ item.count|floatformat:0|intcomma:False }}</td>
                                                </tr>
                                            {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block date %}
    <script src="{% static 'js/table1/tableExport.min.js' %}"></script>
    <script src="{% static 'js/table1/bootstrap-table.min.js' %}"></script>
    <script src="{% static 'js/table1/bootstrap-table-locale-all.min.js' %}"></script>
    <script src="{% static 'js/table1/bootstrap-table-export.min.js' %}"></script>
    <script src="{% static 'js/table1/natural-sorting.js' %}"></script>
    <script src="{% static 'js/table1/bootstrap-table-filter-control.min.js' %}"></script>
    <script src="{% static 'js/table1/bootstrap-table-print.min.js' %}"></script>
    <script src="{% static 'js/table1/jspdf.min.js' %}"></script>
    <script src="{% static 'js/table1/jspdf.plugin.autotable.js' %}"></script>
    <script>
        $(function () {
            $('#table').bootstrapTable();
        });
        function priceFormatter(data) {
            var field = this.field;
            var result = data.map(function (row) {
                var valueString = row[field].replace(/,/g, '');
                var value = parseFloat(valueString);
                return isNaN(value) ? 0 : value;
            }).reduce(function (sum, i) {
                return sum + i;
            }, 0);
            $('#total-mandah').text(result.toLocaleString('fa-IR'));
            return result.toLocaleString('fa-IR');
        }
    </script>
{% endblock %}