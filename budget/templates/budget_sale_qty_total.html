{% extends 'shared/_MainLayout.html' %}
{% load static %}
{% load humanize %}
{% block content %}
    <style>
        .category-btn {
            width: 300px;
            margin-bottom: 10px;
        }
        .btn-fixed-width {
            width: 140px;
            text-align: right;
        }
    </style>
    <style>
        label { display: none !important; }
        #chartdiv svg text { display: none; }
        .am5-label { visibility: hidden; }
    </style>
    <div class="content-wrapper">
        <div class="page-title">
            <div class="row">
                <div class="col-sm-6">
                    <div class="d-block">
                        <h4 class="card-title text-facebook pb-0 border-0">گزارش کلیات بودجه فروش مقداری
                            سال {{ acc_year }}</h4>
                    </div>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb pt-0 pr-0 float-left float-sm-right">
                        <li class="breadcrumb-item"><a href="/" class="default-color"> خانه</a></li>
                        <li class="breadcrumb-item active">گزارش کلیات بودجه فروش مقداری سال {{ acc_year }}</li>
                    </ol>
                </div>
            </div>

            <!-- Drill-Down Treemap -->
            <div class="row">
                <div class="col-md-12 mb-30">
                    <div class="col-xl-12 mb-30">
                        <div class="card card-statistics h-100">
                            <div class="card-body">
                                <div class="table-responsive mt-15 ">
                                    <h6 class="card-title pb-0 border-0">عملکرد فروش مقداری سال {{ acc_year }}</h6>
                                    <div id="chartdiv" style="width: 100%; height: 500px;"></div>
                                    <button id="homeButtonHtml" style="
                                        margin-top: 10px;
                                        padding: 10px 20px;
                                        font-size: 16px;
                                        cursor: pointer;
                                        background-color: #6A0DAD;
                                        color: white;
                                        border: none;
                                        border-radius: 5px;
                                    ">
                                        <i class="fa fa-home" aria-hidden="true"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- سطح 0 -->
            <div class="row">
                <div class="col-md-12 mb-30">
                    <div class="col-xl-12 mb-30">
                        <div class="card card-statistics h-100">
                            <div class="card-body">
                                <div class="table-responsive mt-15 ">
                                    <h6 class="card-title pb-0 border-0">عملکرد فروش مقداری سال {{ acc_year }}</h6>
                                    <div class="table-responsive">
                                        <table id="table"
                                               class="table-striped"
                                               data-toggle="table"
                                               data-locale="fa-IR"
                                               data-search="true"
                                               data-show-columns="true"
                                               data-show-export="true"
                                               data-show-refresh="true"
                                               data-show-columns-toggle-all="true"
                                               data-show-pagination-switch="true"
                                               data-show-toggle="true"
                                               data-show-fullscreen="true"
                                               data-buttons="buttons"
                                               data-search-align="left"
                                               data-buttons-class="primary"
                                               data-pagination="true"
                                               data-show-columns-search="true"
                                               data-show-footer="true"
                                               data-page-size="100"
                                               data-remember-order="true"
                                               data-sortable="true"
                                               data-show-search-clear-button="true"
                                               data-sort-name="cy_factor"
                                               data-sort-order="desc"
                                               data-filter-control="true"
                                               data-show-print="true"
                                               data-export-data-type="all"
                                               data-export-types='["excel"]'>
                                            <thead>
                                            <tr class="tr-class-1">
                                                <th></th>
                                                <th data-field="by_factor" class="card-text text-center"
                                                    data-sortable="true" data-sorter="numericOnly"
                                                    data-footer-formatter="priceFormatter"> کل
                                                    فروش{{ base_year }} (تعداد)</th>
                                                <th data-field="by_today_factor" class="card-text text-center"
                                                    data-sortable="true" data-sorter="numericOnly"
                                                    data-footer-formatter="priceFormatter">
                                                    فروش{{ base_year }} تا امروز (تعداد)
                                                </th>
                                                <th data-field="budget_rate" class="card-text text-center"
                                                    data-sortable="true" data-sorter="numericOnly">ضریب بودجه
                                                </th>
                                                <th data-field="actual_ratio_by_year" class="card-text text-center"
                                                    data-sortable="true" data-sorter="numericOnly">ضریب واقعی
                                                </th>
                                                <th data-field="cy_budget" class="card-text text-center"
                                                    data-sortable="true" data-sorter="numericOnly"
                                                    data-footer-formatter="priceFormatter">
                                                    بودجه{{ acc_year }} (تعداد)</th>
                                                <th data-field="cy_factor" class="card-text text-center"
                                                    data-sortable="true" data-sorter="numericOnly"
                                                    data-footer-formatter="priceFormatter">فروش{{ acc_year }}تا امروز (تعداد)
                                                </th>
                                                <th data-field="cy_today_budget" class="card-text text-center"
                                                    data-sortable="true" data-sorter="numericOnly"
                                                    data-footer-formatter="priceFormatter">بودجه{{ acc_year }} با آهنگ
                                                    پارسال تا امروز (تعداد)
                                                </th>
                                                <th data-field="amalkard_by_year_ratio" class="card-text text-center"
                                                    data-sortable="true" data-sorter="numericOnly"
                                                >عملکرد نسبت به بودجه (آهنگ پارسال)
                                                </th>
                                                <th data-field="cy_today_budget_line" class="card-text text-center"
                                                    data-sortable="true" data-sorter="numericOnly"
                                                    data-footer-formatter="priceFormatter">بودجه{{ acc_year }}
                                                    بصورت خطی تا امروز (تعداد)
                                                </th>
                                                <th data-field="amalkard_by_line_ratio" class="card-text text-center"
                                                    data-sortable="true" data-sorter="numericOnly"
                                                >عملکرد نسبت به بودجه (خطی)
                                                </th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                            {% for item in table0 %}
                                                <tr>
                                                    <td>
                                                        <a href="/budget/sale/qty/detail/0/0"
                                                           target="_blank">
                                                            <button type="button"
                                                                    class="btn btn-sm btn-success btn-fixed-width">
                                                                <i class="ti-bar-chart pr-1"></i> نمودار عملکرد
                                                            </button>
                                                        </a>
                                                    </td>
                                                    <td class="card-text text-center">{{ item.by_factor|floatformat:0|intcomma:False }}</td>
                                                    <td class="card-text text-center">{{ item.by_today_factor|floatformat:0|intcomma:False }}</td>
                                                    <td class="card-text text-center">{{ item.budget_rate|floatformat:2 }}</td>
                                                    <td class="card-text text-center">{{ item.actual_ratio_by_year|floatformat:2 }}</td>
                                                    <td class="card-text text-center">{{ item.cy_budget|floatformat:0|intcomma:False }}</td>
                                                    <td class="card-text text-center">{{ item.cy_factor|floatformat:0|intcomma:False }}</td>
                                                    <td class="card-text text-center">{{ item.cy_today_budget|floatformat:0|intcomma:False }}</td>
                                                    {% if item.amalkard1 %}
                                                        <td class="card-text text-center text-success"
                                                            style="direction: ltr">{{ item.amalkard_by_year_ratio|floatformat:0 }}%
                                                        </td>
                                                    {% else %}
                                                        <td class="card-text text-center text-danger"
                                                            style="direction: ltr">{{ item.amalkard_by_year_ratio|floatformat:0 }}%
                                                        </td>
                                                    {% endif %}
                                                    <td class="card-text text-center">{{ item.cy_today_budget_line|floatformat:0|intcomma:False }}</td>
                                                    {% if item.amalkard2 %}
                                                        <td class="card-text text-center text-success"
                                                            style="direction: ltr">{{ item.amalkard_by_line_ratio|floatformat:0 }}%
                                                        </td>
                                                    {% else %}
                                                        <td class="card-text text-center text-danger"
                                                            style="direction: ltr">{{ item.amalkard_by_line_ratio|floatformat:0 }}%
                                                        </td>
                                                    {% endif %}
                                                </tr>
                                            {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- سطح 1 -->
            <div class="row">
                <div class="col-md-12 mb-30">
                    <div class="col-xl-12 mb-30">
                        <div class="card card-statistics h-100">
                            <div class="card-body">
                                <div class="table-responsive mt-15 ">
                                    <h5 class="card-title pb-0 border-0">بر اساس سطح 1</h5>
                                    <h6 class="card-title pb-0 border-0">عملکرد فروش مقداری سال {{ acc_year }}</h6>
                                    <div class="table-responsive">
                                        <table id="table1"
                                               class="table-striped"
                                               data-toggle="table"
                                               data-locale="fa-IR"
                                               data-search="true"
                                               data-show-columns="true"
                                               data-show-export="true"
                                               data-show-refresh="true"
                                               data-show-columns-toggle-all="true"
                                               data-show-pagination-switch="true"
                                               data-show-toggle="true"
                                               data-show-fullscreen="true"
                                               data-buttons="buttons"
                                               data-search-align="left"
                                               data-buttons-class="primary"
                                               data-pagination="true"
                                               data-show-columns-search="true"
                                               data-show-footer="true"
                                               data-page-size="100"
                                               data-remember-order="true"
                                               data-sortable="true"
                                               data-show-search-clear-button="true"
                                               data-sort-name="cy_factor"
                                               data-sort-order="desc"
                                               data-filter-control="true"
                                               data-show-print="true"
                                               data-export-data-type="all"
                                               data-export-types='["excel"]'>
                                            <thead>
                                            <tr class="tr-class-1">
                                                <th></th>
                                                <th data-field="l1" class="card-text text-center"
                                                    data-sortable="true" data-filter-control="select">سطح 1
                                                </th>
                                                <th data-field="by_factor" class="card-text text-center"
                                                    data-sortable="true" data-sorter="numericOnly"
                                                    data-footer-formatter="priceFormatter"> کل
                                                    فروش{{ base_year }} (تعداد)</th>
                                                <th data-field="by_today_factor" class="card-text text-center"
                                                    data-sortable="true" data-sorter="numericOnly"
                                                    data-footer-formatter="priceFormatter">
                                                    فروش{{ base_year }} تا امروز (تعداد)
                                                </th>
                                                <th data-field="budget_rate" class="card-text text-center"
                                                    data-sortable="true" data-sorter="numericOnly">ضریب بودجه
                                                </th>
                                                <th data-field="actual_ratio_by_year" class="card-text text-center"
                                                    data-sortable="true" data-sorter="numericOnly">ضریب واقعی
                                                </th>
                                                <th data-field="cy_budget" class="card-text text-center"
                                                    data-sortable="true" data-sorter="numericOnly"
                                                    data-footer-formatter="priceFormatter">
                                                    بودجه{{ acc_year }} (تعداد)</th>
                                                <th data-field="cy_factor" class="card-text text-center"
                                                    data-sortable="true" data-sorter="numericOnly"
                                                    data-footer-formatter="priceFormatter">فروش{{ acc_year }}تا امروز (تعداد)
                                                </th>
                                                <th data-field="cy_today_budget" class="card-text text-center"
                                                    data-sortable="true" data-sorter="numericOnly"
                                                    data-footer-formatter="priceFormatter">بودجه{{ acc_year }} با آهنگ
                                                    پارسال تا امروز (تعداد)
                                                </th>
                                                <th data-field="amalkard_by_year_ratio" class="card-text text-center"
                                                    data-sortable="true" data-sorter="numericOnly"
                                                >عملکرد نسبت به بودجه (آهنگ پارسال)
                                                </th>
                                                <th data-field="cy_today_budget_line" class="card-text text-center"
                                                    data-sortable="true" data-sorter="numericOnly"
                                                    data-footer-formatter="priceFormatter">بودجه{{ acc_year }}
                                                    بصورت خطی تا امروز (تعداد)
                                                </th>
                                                <th data-field="amalkard_by_line_ratio" class="card-text text-center"
                                                    data-sortable="true" data-sorter="numericOnly"
                                                >عملکرد نسبت به بودجه (خطی)
                                                </th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                            {% for item in table1 %}
                                                <tr>
                                                    <td>
                                                        <a href="/budget/sale/qty/detail/1/{{ item.cat_id }}"
                                                           target="_blank">
                                                            <button type="button"
                                                                    class="btn btn-sm btn-success btn-fixed-width">
                                                                <i class="ti-bar-chart pr-1"></i> نمودار عملکرد
                                                            </button>
                                                        </a>
                                                        <a href="/budget/sale/factor/{{ acc_year }}/1/{{ item.cat_id }}"
                                                           target="_blank">
                                                            <button type="button"
                                                                    class="btn btn-sm btn-danger btn-fixed-width">
                                                                <i class="ti-wallet pr-1"></i> فاکتورهای {{ acc_year }}
                                                            </button>
                                                        </a>
                                                        <a href="/budget/sale/factor/{{ base_year }}/1/{{ item.cat_id }}"
                                                           target="_blank">
                                                            <button type="button"
                                                                    class="btn btn-sm btn-primary btn-fixed-width">
                                                                <i class="ti-wallet pr-1"></i> فاکتورهای {{ base_year }}
                                                            </button>
                                                        </a>
                                                        <a href="/budget/sale/backfactor/{{ acc_year }}/1/{{ item.cat_id }}"
                                                           target="_blank">
                                                            <button type="button"
                                                                    class="btn btn-sm btn-warning btn-fixed-width">
                                                                <i class="ti-rotate-left pr-1"></i> برگشتی {{ acc_year }}
                                                            </button>
                                                        </a>
                                                        <a href="/budget/sale/backfactor/{{ base_year }}/1/{{ item.cat_id }}"
                                                           target="_blank">
                                                            <button type="button"
                                                                    class="btn btn-sm btn-secondary btn-fixed-width">
                                                                <i class="ti-rotate-left pr-1"></i> برگشتی {{ base_year }}
                                                            </button>
                                                        </a>
                                                    </td>
                                                    <td class="card-text text-center">{{ item.l1 }}</td>
                                                    <td class="card-text text-center">{{ item.by_factor|floatformat:0|intcomma:False }}</td>
                                                    <td class="card-text text-center">{{ item.by_today_factor|floatformat:0|intcomma:False }}</td>
                                                    <td class="card-text text-center">{{ item.budget_rate|floatformat:2 }}</td>
                                                    <td class="card-text text-center">{{ item.actual_ratio_by_year|floatformat:2 }}</td>
                                                    <td class="card-text text-center">{{ item.cy_budget|floatformat:0|intcomma:False }}</td>
                                                    <td class="card-text text-center">{{ item.cy_factor|floatformat:0|intcomma:False }}</td>
                                                    <td class="card-text text-center">{{ item.cy_today_budget|floatformat:0|intcomma:False }}</td>
                                                    {% if item.amalkard1 %}
                                                        <td class="card-text text-center text-success"
                                                            style="direction: ltr">{{ item.amalkard_by_year_ratio|floatformat:0 }}%
                                                        </td>
                                                    {% else %}
                                                        <td class="card-text text-center text-danger"
                                                            style="direction: ltr">{{ item.amalkard_by_year_ratio|floatformat:0 }}%
                                                        </td>
                                                    {% endif %}
                                                    <td class="card-text text-center">{{ item.cy_today_budget_line|floatformat:0|intcomma:False }}</td>
                                                    {% if item.amalkard2 %}
                                                        <td class="card-text text-center text-success"
                                                            style="direction: ltr">{{ item.amalkard_by_line_ratio|floatformat:0 }}%
                                                        </td>
                                                    {% else %}
                                                        <td class="card-text text-center text-danger"
                                                            style="direction: ltr">{{ item.amalkard_by_line_ratio|floatformat:0 }}%
                                                        </td>
                                                    {% endif %}
                                                </tr>
                                            {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- سطح 2 و 3 را مشابه بالا اضافه کنید -->

        </div>
    </div>
{% endblock %}
{% block date %}
    <!-- اسکریپت‌های جدول -->
    <script src="{% static 'js/table1/tableExport.min.js' %}"></script>
    <script src="{% static 'js/table1/bootstrap-table.min.js' %}"></script>
    <!-- ... سایر اسکریپت‌های جدول ... -->
    <script>
        $(function () {
            $('#table, #table1, #table2, #table3').bootstrapTable();
        });
        function priceFormatter(data) {
            var field = this.field;
            var result = data.map(function (row) {
                var valueString = row[field].replace(/,/g, '');
                var value = parseFloat(valueString);
                return isNaN(value) ? 0 : value;
            }).reduce(function (sum, i) {
                return sum + i;
            }, 0);
            return result.toLocaleString('fa-IR');
        }
    </script>
{% endblock %}
{% block myjs %}
    <!-- Resources -->
    <script src="{% static 'js/amcharts/index.js' %}"></script>
    <script src="{% static 'js/amcharts/hierarchy.js' %}"></script>
    <script src="{% static 'js/amcharts/Animated.js' %}"></script>
    <script>
        am5.ready(function () {
            console.log("AmCharts ready function started.");
            var table10 = {{ table10|safe }};
            var table20 = {{ table20|safe }};
            var table30 = {{ table30|safe }};
            console.log("Raw table10 data:", table10);
            console.log("Raw table20 data:", table20);
            console.log("Raw table30 data:", table30);
            function filterAndParseColumns(dataArray) {
                return dataArray.map(item => ({
                    l1: item.l1,
                    l2: item.l2,
                    l3: item.l3,
                    cy_factor: parseFloat(item.cy_factor) || 0
                }));
            }
            var t1 = filterAndParseColumns(table10);
            var t2 = filterAndParseColumns(table20);
            var t3 = filterAndParseColumns(table30);
            function buildHierarchy(table10, table20, table30) {
                const l1Map = new Map(table10.map(item => [item.l1, item.cy_factor]));
                const l2Map = new Map(table20.map(item => [`${item.l1}|${item.l2}`, item.cy_factor]));
                const l3Map = new Map(table30.map(item => [`${item.l1}|${item.l2}|${item.l3}`, item.cy_factor]));
                let rootCyFactor = 0;
                table10.forEach(item => {
                    rootCyFactor += item.cy_factor || 0;
                });
                const rootNode = {name: "همه دسته‌ها", children: [], value: rootCyFactor};
                table10.forEach(item1 => {
                    const l1Name = item1.l1;
                    const l1Value = l1Map.get(l1Name);
                    if (l1Value > 0) {
                        let level1Node = {
                            name: l1Name,
                            value: l1Value,
                            children: []
                        };
                        rootNode.children.push(level1Node);
                        const relatedLevel2 = table20.filter(t => t.l1 === l1Name);
                        relatedLevel2.forEach(item2 => {
                            const l2Name = item2.l2;
                            const l2Value = l2Map.get(`${l1Name}|${l2Name}`);
                            if (l2Value > 0) {
                                let level2Node = {
                                    name: l2Name,
                                    value: l2Value,
                                    children: []
                                };
                                level1Node.children.push(level2Node);
                                const relatedLevel3 = table30.filter(t => t.l1 === l1Name && t.l2 === l2Name);
                                relatedLevel3.forEach(item3 => {
                                    const l3Name = item3.l3;
                                    const l3Value = l3Map.get(`${l1Name}|${l2Name}|${l3Name}`);
                                    if (l3Value > 0) {
                                        level2Node.children.push({
                                            name: l3Name,
                                            value: l3Value
                                        });
                                    }
                                });
                            }
                        });
                    }
                });
                return rootNode;
            }
            const hierarchyData = [buildHierarchy(t1, t2, t3)];
            console.log("Final Hierarchy Data:", JSON.stringify(hierarchyData, null, 2));
            var root = am5.Root.new("chartdiv");
            const myRTLTheme = am5.Theme.new(root);
            myRTLTheme.rule("Root").set("rtl", true);
            root.setThemes([
                am5themes_Animated.new(root),
                myRTLTheme
            ]);
            var zoomableContainer = root.container.children.push(
                am5.ZoomableContainer.new(root, {
                    width: am5.p100,
                    height: am5.p100,
                    wheelable: true,
                    pinchZoom: true
                })
            );
            var series = zoomableContainer.contents.children.push(
                am5hierarchy.Treemap.new(root, {
                    maskContent: false,
                    sort: "descending",
                    singleBranchOnly: false,
                    downDepth: 1,
                    upDepth: 0,
                    initialDepth: 1,
                    valueField: "value",
                    categoryField: "name",
                    childDataField: "children"
                })
            );
            series.nodes.template.setAll({
                tooltipText: "[bold]{value.formatNumber('#,###.')}[/]",
                tooltip: am5.Tooltip.new(root, {
                    getFillFromSprite: true,
                    label: am5.Label.new(root, {
                        text: ""
                    })
                })
            });
            series.labels.template.set("forceHidden", true);
            series.nodes.template.adapters.add("fill", function (fill, target) {
                var dataItem = target.dataItem;
                if (dataItem) {
                    var depth = dataItem.get("depth");
                    if (depth === 0) return am5.color(0x6A0DAD);
                    else if (depth === 1) return fill;
                    else if (depth === 2) return am5.color(0xADD8E6);
                    else if (depth === 3) return am5.color(0xFFB6C1);
                }
                return fill;
            });
            series.data.setAll(hierarchyData);
            series.set("selectedDataItem", series.dataItems[0]);
            series.bullets.push(function (root, series, dataItem) {
                var depth = dataItem.get("depth");
                if (depth >= 1 && depth <= 3) {
                    var label = am5.Label.new(root, {
                        text: dataItem.dataContext.name,
                        oversizedBehavior: "truncate",
                        truncate: true,
                        maxRight: am5.percent(95),
                        maxLeft: am5.percent(5),
                        centerX: am5.p50,
                        centerY: am5.p50,
                        textAlign: "center",
                        paddingLeft: 2,
                        paddingRight: 2,
                        paddingTop: 2,
                        paddingBottom: 2,
                    });
                    if (depth === 1) {
                        label.setAll({
                            fill: am5.color(0xffffff),
                            fontSize: 18,
                            fontWeight: "bold"
                        });
                    } else if (depth === 2) {
                        label.setAll({
                            fill: am5.color(0x000000),
                            fontSize: 14
                        });
                    } else if (depth === 3) {
                        label.setAll({
                            fill: am5.color(0x000000),
                            fontSize: 12
                        });
                    }
                    return am5.Bullet.new(root, {sprite: label});
                }
                return undefined;
            });
            series.nodes.template.events.on("click", function (ev) {
                var dataItem = ev.target.dataItem;
                var depth = dataItem.get("depth");
                var children = dataItem.get("children");
                if (depth === 0) {
                    series.set("downDepth", 1);
                    series.selectDataItem(dataItem);
                } else if (depth === 1) {
                    if (children && children.length > 0) {
                        series.set("downDepth", 2);
                        series.selectDataItem(dataItem);
                    }
                } else if (depth === 2) {
                    if (children && children.length > 0) {
                        series.set("downDepth", 3);
                        series.selectDataItem(dataItem);
                    }
                } else if (depth === 3) {
                    if (dataItem.get("parent")) {
                        series.set("downDepth", 2);
                        series.selectDataItem(dataItem.get("parent"));
                    }
                }
            });
            var htmlHomeButton = document.getElementById("homeButtonHtml");
            if (htmlHomeButton) {
                htmlHomeButton.addEventListener("click", function () {
                    series.set("downDepth", 1);
                    series.selectDataItem(series.dataItems[0]);
                });
            }
        });
    </script>
{% endblock %}