{% extends 'shared/_MainLayout.html' %}
{% load static %}
{% load humanize %}

{% block content %}
    <style>
        /* این استایل ها فقط برای این صفحه اعمال می شوند */
        .category-btn {
            width: 300px; /* عرض دکمه‌ها را تنظیم می‌کند */
            margin-bottom: 10px; /* فاصله بین خطوط را تنظیم می‌کند */
        }

        /* CSS برای کنترل اندازه نمودار */
        .chart-container {
            position: relative;
            width: 100%; /* می تواند عرض ثابتی هم باشد */
            height: 450px; /* ارتفاع دلخواه برای نمودار ترکیبی */
            margin-bottom: 30px;
            background-color: #fff;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        /* اگر فونت IRANSans را سراسری در _MainLayout تنظیم نکرده‌اید، اینجا اضافه کنید */
        body {
            font-family: 'IRANSans', Tahoma, sans-serif;
            /* direction: rtl;  این احتمالا در _MainLayout تنظیم شده است */
            /* text-align: right; این احتمالا در _MainLayout تنظیم شده است */
        }

        h5.card-title, h6.card-title {
            text-align: right;
            margin-bottom: 10px;
        }
    </style>


    <div class="content-wrapper">
        <div class="page-title">


            <div class="row">
                <div class="col-sm-6">
                    <div class="d-block">
                        <h4 class="card-title text-facebook pb-0 border-0">گزارش جزئیات بودجه هزینه
                            سال {{ acc_year }} - {{ detail_name }}</h4>
                    </div>

                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb pt-0 pr-0 float-left float-sm-right">
                        <li class="breadcrumb-item"><a href="/" class="default-color"> خانه</a></li>
                        <li class="breadcrumb-item active">گزارش کلیات بودجه هزینه سال {{ acc_year }}</li>
                    </ol>
                </div>
            </div>

            <!-- دکمه سطوح -->
            <div class="col-xl-12 mb-30">
                <div class="card card-statistics h-100">
                    <div class="card-body">
                        {#                        <h5 class="card-title">سطح کل</h5>#}
                        <div class="text-center">
                            {% for l in level1 %}
                                <a href="/budget/cost/detail/1/{{ l.code }}">
                                    <button type="button"
                                            class="btn btn-success category-btn">{{ l.code }}-{{ l.name }}</button>
                                </a>
                            {% endfor %}

                        </div>

                    </div>

                </div>
            </div>
            <div class="col-xl-12 mb-30">
                <div class="card card-statistics h-100">
                    <div class="card-body">
                        {#                            <h5 class="card-title">سطح معین</h5>#}
                        <div class="text-center">
                            {% for l in level2 %}
                                {% if l.code == moin_code %}
                                    <a href="/budget/cost/detail/2/{{ l.code }}">
                                        <button type="button"
                                                class="btn btn-success category-btn">{{ l.code }}-{{ l.name }}</button>
                                    </a>
                                {% else %}
                                    <a href="/budget/cost/detail/2/{{ l.code }}">
                                        <button type="button"
                                                class="btn btn-secondary category-btn">{{ l.code }}-{{ l.name }}</button>
                                    </a>
                                {% endif %}
                            {% endfor %}

                        </div>

                    </div>

                </div>
            </div>
            {% if level > 1 %}
                <div class="col-xl-12 mb-30">
                    <div class="card card-statistics h-100">
                        <div class="card-body">
                            {#                            <h5 class="card-title">سطح تفضیلی</h5>#}
                            <div class="text-center">
                                {% for l in level3 %}
                                    {% if l.code == tafzili_code %}
                                        <a href="/budget/cost/detail/3/{{ l.code }}">
                                            <button type="button"
                                                    class="btn btn-success category-btn">{{ l.code }}-{{ l.name }}</button>
                                        </a>
                                    {% else %}
                                        <a href="/budget/cost/detail/3/{{ l.code }}">
                                            <button type="button"
                                                    class="btn btn-secondary category-btn">{{ l.code }}-{{ l.name }}</button>
                                        </a>
                                    {% endif %}
                                {% endfor %}

                            </div>

                        </div>

                    </div>
                </div>
            {% endif %}

            <!-- ردیف خلاصه -->
            <div class="row">
                <div class="col-xl-3 col-lg-6 col-md-6 mb-30">
                    <div class="card card-statistics h-100">
                        <div class="card-body">
                            <div class="clearfix">
                                <div class="float-left icon-box bg-primary rounded-circle">
    <span class="text-white">
    <i class="fa fa-calendar highlight-icon" aria-hidden="true"></i>
    </span>
                                </div>
                                <div class="float-right text-right">
                                    <p class="card-text text-dark">کل عملکرد سال قبل</p>
                                    <h4>{{ master_dat.by_sanads|intword}} تومان </h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-lg-6 col-md-6 mb-30">
                    <div class="card card-statistics h-100">
                        <div class="card-body">
                            <div class="clearfix">
                                <div class="float-left icon-box bg-danger rounded-circle">
    <span class="text-white">
    <i class="fa fa-flag-checkered highlight-icon" aria-hidden="true"></i>
    </span>
                                </div>
                                <div class="float-right text-right">
                                    <p class="card-text text-dark">کل بودجه امسال</p>
                                    <h4>{{ master_dat.cy_budget|intword}} تومان </h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-lg-6 col-md-6 mb-30">
                    <div class="card card-statistics h-100">
                        <div class="card-body">
                            <div class="clearfix">
                                <div class="float-left icon-box bg-info rounded-circle">
    <span class="text-white">
    <i class="fa fa-info highlight-icon" aria-hidden="true"></i>
    </span>
                                </div>
                                <div class="float-right text-right">
                                    <p class="card-text text-dark"> ضریب بودجه </p>
                                    <h4>{{ master_dat.budget_rate|floatformat:2|intcomma:False }} </h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-lg-6 col-md-6 mb-30">
                    <div class="card card-statistics h-100">
                        <div class="card-body">
                            <div class="clearfix">
                                <div class="float-left icon-box bg-success rounded-circle">
    <span class="text-white">
    <i class="fa fa- fa-spinner fa-spin highlight-icon" aria-hidden="true"></i>
    </span>
                                </div>
                                <div class="float-right text-right">
                                    <p class="card-text text-dark"> عملکرد امسال </p>
{#                                    <h4>{{ master_dat.cy_sanads|floatformat:1|intcomma:False }} میلیون تومان </h4>#}
                                    <h4>{{ master_dat.cy_sanads|intword}} تومان </h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ردیف گیج -->
{#            <div class="row">#}
{#                <div class="col-md-12 mb-30">#}
{#                    <div class="col-xl-12 mb-30">#}
{#                        <div class="card card-statistics h-100">#}
{#                            <div class="card-body">#}
{#                                <div class="table-responsive mt-15 ">#}
{#                                    <h5 class="card-title pb-0 border-0">عملکرد بودجه هزینه ای#}
{#                                        برای: {{ detail_name }}</h5>#}
{#                                </div>#}
{##}
{#<canvas id="gaugeChart" width="200" height="200"></canvas>#}
{##}
{#                            </div>#}
{#                        </div>#}
{#                    </div>#}
{#                </div>#}
{#            </div>#}


                    <!-- ردیف نمودار -->

            <div class="row">
                <div class="col-md-12 mb-30">
                    <div class="col-xl-12 mb-30">
                        <div class="card card-statistics h-100">
                            <div class="card-body">
                                <div class="table-responsive mt-15 ">
                                    <h5 class="card-title pb-0 border-0">عملکرد بودجه هزینه ای
                                        برای: {{ detail_name }}</h5>
                                </div>

                                <div class="chart-container ">
                                    <canvas id="budgetChart"></canvas>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>



{% endblock %}

{% block myjs %}
    <script>
        // دریافت داده‌ها از View
        var chartLabels = {{ chart_labels|safe }};
        var chart1Data = {{ chart1_data|safe }};
        var chart2Data = {{ chart2_data|safe }};
        var chart3Data = {{ chart3_data|safe }};
        var chart4Data = {{ chart4_data|safe }};

        var ctx = document.getElementById('budgetChart').getContext('2d');

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartLabels,
                datasets: [
                    {
                        label: "عملکرد سال گذشته",
                        data: chart1Data,
                        borderColor: "blue",
                        fill: false,
                        pointRadius: 0 // حذف دایره‌های داده
                    },
                    {
                        label: "عملکرد سال جاری",
                        data: chart2Data,
                        borderColor: "green",
                        fill: false,
                        pointRadius: 0 // حذف دایره‌های داده
                    },
                    {
                        label: "بودجه با آهنگ سال گذشته",
                        data: chart3Data,
                        borderColor: "red",
                        fill: false,
                        pointRadius: 0 // حذف دایره‌های داده
                    },
                    {
                        label: "بودجه بر اساس زمان",
                        data: chart4Data,
                        borderColor: "teal",
                        fill: false,
                        pointRadius: 0 // حذف دایره‌های داده
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {title: {display: true, text: "تاریخ"}},
                    y: {title: {display: true, text: "مقدار تجمعی"}}
                }
            }
        });
    </script>


<script>
        // تنظیمات نمودار گیج
        const gaugeCanvas = document.getElementById('gaugeChart');
        const gaugeCtx = gaugeCanvas.getContext('2d');

        const gaugeChart = new Chart(gaugeCtx, {
            type: 'doughnut',
            data: {
                labels: ['مصرف', 'باقیمانده'],
                datasets: [{
                    data: [60, 40], // مقدار فعلی گیج (مثلاً 60٪ مصرف شده)
                    backgroundColor: ['#FF5733', '#DDDDDD'],
                    borderWidth: 0
                }]
            },
            options: {
                cutout: '80%', // تنظیم برش داخلی برای ایجاد گیج
                rotation: -90, // شروع از زاویه 270 درجه
                circumference: 180, // نمایش فقط نیمه بالایی برای گیج
                plugins: {
                    tooltip: { enabled: false }
                }
            }
        });

        // تابع برای رسم عقربه روی نمودار
        function drawNeedle(ctx, value, centerX, centerY, radius) {
            const angle = Math.PI * (1 - (value / 100)); // محاسبه زاویه (بین 0 و 180 درجه)

            ctx.beginPath();
            ctx.moveTo(centerX, centerY); // نقطه شروع از مرکز نمودار
            ctx.lineTo(centerX + radius * Math.cos(angle), centerY - radius * Math.sin(angle)); // نقطه انتهایی عقربه
            ctx.lineWidth = 4;
            ctx.strokeStyle = "#333"; // رنگ عقربه
            ctx.stroke();
        }

        // رسم عقربه روی نمودار (مثلاً مقدار 75٪)
        drawNeedle(gaugeCtx, 75, gaugeCanvas.width / 2, gaugeCanvas.height / 2, 50);
    </script>


{% endblock %}